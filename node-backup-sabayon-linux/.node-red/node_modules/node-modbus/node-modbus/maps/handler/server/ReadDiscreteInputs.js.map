{"version":3,"sources":["handler/server/ReadDiscreteInputs.js"],"names":["stampit","require","handler","init","debug","this","log","responseDelay","bind","setRequestHandler","onRequest","setTimeout","pdu","cb","length","buf","Buffer","allocUnsafe","writeUInt8","quantity","readUInt16BE","emit","start","mem","getInput","thisByteBitCount","byteIdx","byteCount","Math","response","floor","totalBitCount","val","module","exports"],"mappings":"AAIA,aAEA,IAAIA,QAAUC,QAAQ,WAElBC,QAAUF,UAEVG,KAAIA,WACF,IAAAA,EAASC,WAATC,KAAKC,IAAIF,MAAM,oDAGRG,KAAAA,gBACNF,KAAAE,cAAA,GAGDC,KAAKC,kBARP,EAAAC,IAQEF,KAAKH,MAGLM,EAAW,SAAYC,EAAAC,GACrBF,WAASP,WAGP,GAHFC,KAAKC,IAAIF,MAAM,0CAGE,IAAfQ,EAAAE,OAAe,CAAfT,KAAKC,IAAIF,MAAM,qBAEf,IAAIW,EAAMC,OAAOC,YAAY,GAO9B,OAJCF,EAAIG,WAAW,IAAf,GACAL,EAAAK,WAAA,EAAA,QAAAL,EAAGE,GAML,IAAII,EAAAA,EAAWP,aAAA,GAAXO,EAAWP,EAAIQ,aAAa,GAEhCf,KAAKgB,KAAK,4BAA6BC,EAAOH,GAE9C,IAAII,EAAMlB,KAAKmB,WAGb,GAAAF,EAAe,EAANlB,EAAMU,QAAAQ,EAAfH,EAAA,EAAAI,EAAAT,OAAA,CAAAT,KAAKC,IAAIF,MAAM,qBAEf,IAAIW,EAAMC,OAAOC,YAAY,GAO9B,OAJCF,EAAIG,WAAW,IAAf,GACAL,EAAGE,WAAH,EAAA,QAAAF,EAAGE,GAML,IAAIU,EAAAA,EACAC,EAAJ,EACIC,EAAYC,EACZC,EAAWb,KAAOC,KAAAA,EAAgBU,GAAlCE,EAAWb,OAAOC,YAAY,EAAIU,GAGtCE,EAASX,WAAWS,EAAAA,GAApBE,EAASX,WAAWS,EAAW,GAG7B,IAAIZ,IAAAA,EAAMO,EAAmBQ,EAAMC,EAAnCZ,EAAAY,GAAA,EAAA,CACWR,EAAMQ,UAAAA,KAAAA,MAAjBA,EAAA,IAAW,GAAMA,EAAgB,IAIhCC,GAAA,GAAAP,EAAA,IAEDA,GAAoB,GAGlB,GAAyBC,GAAzBK,IAAAT,EAAAH,EAAA,IACAa,EAASN,WAAUA,EAAAA,GACpBM,EAAA,EAAAN,GAAA,GAIHlB,EAAKqB,IA7DOrB,KAAAH,MAAhBA,KAAAE,gBA8DEC,KAAKH,MA1EXF,MA+EA8B,OAAOC,QAAUhC","file":"../../../handler/server/ReadDiscreteInputs.js","sourcesContent":["/**\n * Modbus server read discrete inputs.\n * @module ModbusServerReadDiscreteInputs\n */\n'use strict'\n\nlet stampit = require('stampit')\n\nlet handler = stampit()\n  .init(function () {\n    let init = function () {\n      this.log.debug('initiating read discrete inputs request handler.')\n\n      if (!this.responseDelay) {\n        this.responseDelay = 0\n      }\n\n      this.setRequestHandler(2, onRequest)\n    }.bind(this)\n\n    let onRequest = function (pdu, cb) {\n      setTimeout(function () {\n        this.log.debug('handling read discrete inputs request.')\n\n        if (pdu.length !== 5) {\n          this.log.debug('wrong pdu length.')\n\n          let buf = Buffer.allocUnsafe(2)\n\n          buf.writeUInt8(0x82, 0)\n          buf.writeUInt8(0x02, 1)\n          cb(buf)\n\n          return\n        }\n\n        let start = pdu.readUInt16BE(1)\n        let quantity = pdu.readUInt16BE(3)\n\n        this.emit('readDiscreteInputsRequest', start, quantity)\n\n        let mem = this.getInput()\n\n        if (start > mem.length * 8 || start + quantity > mem.length * 8) {\n          this.log.debug('wrong pdu length.')\n\n          let buf = Buffer.allocUnsafe(2)\n\n          buf.writeUInt8(0x82, 0)\n          buf.writeUInt8(0x02, 1)\n          cb(buf)\n\n          return\n        }\n\n        let val = 0\n        let thisByteBitCount = 0\n        let byteIdx = 2\n        let byteCount = Math.ceil(quantity / 8)\n        let response = Buffer.allocUnsafe(2 + byteCount)\n\n        response.writeUInt8(0x02, 0)\n        response.writeUInt8(byteCount, 1)\n\n        for (let totalBitCount = start; totalBitCount < start + quantity; totalBitCount += 1) {\n          let buf = mem.readUInt8(Math.floor(totalBitCount / 8))\n          let mask = 1 << (totalBitCount % 8)\n\n          if (buf & mask) {\n            val += 1 << (thisByteBitCount % 8)\n          }\n\n          thisByteBitCount += 1\n\n          if (thisByteBitCount % 8 === 0 || totalBitCount === (start + quantity) - 1) {\n            response.writeUInt8(val, byteIdx)\n            val = 0; byteIdx = byteIdx + 1\n          }\n        }\n\n        cb(response)\n      }.bind(this), this.responseDelay)\n    }.bind(this)\n\n    init()\n  })\n\nmodule.exports = handler\n"]}