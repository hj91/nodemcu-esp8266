"use strict";var stampit=require("stampit"),ModbusCore=require("./modbus-client-core.js");module.exports=stampit().compose(ModbusCore).refs({logLabel:"ModbusTCPClient"}).init(function(){var t=0,e=t,i=!1,o=!1,n=void 0,s=Buffer.alloc(0),r=void 0,c=!0,h=function(){this.setState("init"),this.unitId||(this.unitId=0),this.protocolVersion||(this.protocolVersion=0),this.port||(this.port=502),this.host||(this.host="localhost"),this.autoReconnect||(this.autoReconnect=!1),this.reconnectTimeout||(this.reconnectTimeout=0),this.on("send",m),this.on("newState_error",b),this.on("trashCurrentRequest",p),this.on("stateChanged",this.log.debug)}.bind(this),u=function(t){this.setState("connect"),r||((r=this.injectedSocket?this.injectedSocket:require("net").Socket()).on("connect",d),r.on("close",a),r.on("error",l),r.on("data",g),r.on("timeout",f));try{r.connect(this.port,this.host),this.log.debug("socket connected"),"function"==typeof t&&t()}catch(e){this.log.error(e+" on socket connect"),"function"==typeof t&&t(e)}}.bind(this),d=function(){c=!1,this.setState("ready"),this.emit("connect")}.bind(this),a=function(t){this.log.debug("Socket closed with error",t),this.setState("closed"),this.emit("close"),i||!this.autoReconnect&&!o||setTimeout(function(){o=!1,u()},this.reconnectTimeout||0)}.bind(this),l=function(t){this.logError("Socket Error",t),this.setState("error"),this.emit("error",t)}.bind(this),f=function(){this.logError("Socket Timeout, setting state to error"),this.setState("error"),this.emit("error","timeout")}.bind(this),g=function(t){for(this.log.debug("received data"),s=Buffer.concat([s,t]);s.length>7;){var e=s.readUInt16BE(0),i=s.readUInt16BE(4);if(e===n)return void this.log.debug("current mbap contains trashed request id.");if(s.length<7+i-1)break;this.log.debug("MBAP extracted");var o=s.slice(7,7+i-1);this.log.debug("PDU extracted"),this.emit("data",o),s=s.slice(o.length+7,s.length)}}.bind(this),b=function(){this.log.error("Client in error state."),r.destroy()}.bind(this),m=function(i,o){this.log.debug("Sending pdu to the socket."),t=(t+1)%65535;var n=Buffer.allocUnsafe(7);n.writeUInt16BE(t,0),n.writeUInt16BE(this.protocolVersion,2),n.writeUInt16BE(i.length+1,4),n.writeUInt8(this.unitId,6);var s=Buffer.concat([n,i]);e=t,o(),r.write(s)}.bind(this),p=function(){n=e};this.connect=function(t){return this.setState("connect"),u(t),this},this.reconnect=function(){return this.inState("closed")?(i=!1,o=!0,this.log.debug("Reconnecting client."),r.end(),this):this},this.close=function(t){return c?("function"==typeof t&&t(),this):(c=!0,i=!0,this.log.debug("Closing client on purpose."),r.end(),"function"==typeof t&&t(),this)},process.env.DEBUG&&(this.getSocket=function(){return r},this.setCurrentRequestId=function(t){e=t},this.registerOnSend=function(t){this.removeListener(m),this.on("send",t.bind(this))}),h()});
//# sourceMappingURL=maps/modbus-tcp-client.js.map
