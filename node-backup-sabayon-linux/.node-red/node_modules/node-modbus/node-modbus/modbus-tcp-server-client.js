"use strict";var stampit=require("stampit"),log=require("stampit-log");module.exports=stampit().refs({logLabel:"ModbusTCPServerClient"}).compose(log).init(function(){var t=Buffer.alloc(0),e=function(){if(!this.socket||void 0===this.socketId||!this.onRequest)throw this.log.error("socket:"+this.socket+" socketId:"+this.socketId+"onRequest"+this.onRequest),new Error("No Socket defined.");this.socket.on("end",this.onSocketEnd),this.socket.on("data",this.onSocketData),this.socket.on("error",this.onSocketError)}.bind(this);this.onSocketEnd=function(){this.onEnd&&this.onEnd(),this.log.debug("connection closed, socket",this.socketId)}.bind(this),this.onSocketData=function(e){for(this.log.debug("received data socket",this.socketId,e.byteLength),t=Buffer.concat([t,e]);t.length>8;){var o=t.readUInt16BE(4),s={trans_id:t.readUInt16BE(0),protocol_ver:t.readUInt16BE(2),unit_id:t.readUInt8(6)};if(t.length<7+o-1)break;var i=t.slice(7,7+o);this.log.debug("PDU extracted."),this.onRequest({request:s,pdu:i,socket:this.socket}),t=t.slice(i.length+7,t.length)}}.bind(this),this.onSocketError=function(t){this.log.error("Socker error",t)}.bind(this),e()});
//# sourceMappingURL=maps/modbus-tcp-server-client.js.map
