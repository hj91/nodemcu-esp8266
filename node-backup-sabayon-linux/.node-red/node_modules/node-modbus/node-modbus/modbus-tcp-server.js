"use strict";var stampit=require("stampit"),ModbusServerCore=require("./modbus-server-core.js"),StateMachine=require("stampit-state-machine"),ClientSocket=require("./modbus-tcp-server-client.js");module.exports=stampit().compose(ModbusServerCore).compose(StateMachine).refs({logLabel:"ModbusTCPServer"}).init(function(){var t=require("net"),e=void 0,i=[],s=[],n=[],r=function(){this.port||(this.port=502),this.hostname||(this.hostname="0.0.0.0"),this.netInject&&(t=this.netInject),(e=t.createServer()).on("connection",function(t){if(this.log.debug("new connection",t.address()),this.whiteListIPs&&this.whiteListIPs.indexOf(t.address())<0)return this.log.debug("client connection REJECTED",t.address()),t.end(),!1;n.push(t),h(t)}.bind(this));try{e.listen(this.port,this.hostname,function(t){t&&(this.log.debug("error while listening",t),this.emit("error",t))}.bind(this)),this.log.debug("server is listening on port",this.hostname+":"+this.port),this.on("newState_ready",o),this.setState("ready")}catch(t){this.log.error("server is listening error "+t+" on port",this.hostname+":"+this.port),this.setState("error")}}.bind(this),o=function(){if(!this.inState("processing")&&0!==s.length){this.setState("processing");var t=s.shift();this.onData(t.pdu,function(e){this.log.debug("sending tcp data");var i=Buffer.allocUnsafe(7);i.writeUInt16BE(t.request.trans_id,0),i.writeUInt16BE(t.request.protocol_ver,2),i.writeUInt16BE(e.length+1,4),i.writeUInt8(t.request.unit_id,6);var s=Buffer.concat([i,e]);t.socket.write(s),this.setState("ready")}.bind(this))}}.bind(this),h=function(t){var e=i.length,n=function(){i[e]=void 0;for(var t=i.length-1;t>=0;t-=1){if(void 0!==i[t])break;i.splice(t,1)}this.log.debug("Client connection closed, remaining clients. ",i.length)}.bind(this),r=ClientSocket({socket:t,socketId:e,onRequest:function(t){s.push(t),o()},onEnd:n});i.push(r)}.bind(this);this.close=function(t){for(var i in n)n[i].destroy();e.close(function(){e.unref(),t&&t()})},r()});
//# sourceMappingURL=maps/modbus-tcp-server.js.map
