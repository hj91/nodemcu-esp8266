"use strict";module.exports=function(i){require("source-map-support").install();var n=require("./modbus-basics"),u=require("./core/modbus-core"),d=require("./core/modbus-io-core"),a=require("debug")("contribModbus:getter");i.nodes.registerType("modbus-getter",function(e){i.nodes.createNode(this,e),this.name=e.name,this.unitid=e.unitid,this.dataType=e.dataType,this.adr=e.adr,this.quantity=e.quantity,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.msgThruput=e.msgThruput,this.connection=null,this.useIOFile=e.useIOFile,this.ioFile=i.nodes.getNode(e.ioFile),this.useIOForPayload=e.useIOForPayload;var r=this,o=i.nodes.getNode(e.server);function t(e){var s=n.setNodeStatusProperties(e,r.showStatusActivities);r.status({fill:s.fill,shape:s.shape,text:s.status})}r.bufferMessageList=new Map,t("waiting"),r.onModbusInit=function(){t("initialize")},r.onModbusConnect=function(){t("connected")},r.onModbusActive=function(){t("active")},r.onModbusError=function(e){t("failure"),r.showErrors&&r.warn(e)},r.onModbusClose=function(){t("closed")},r.onModbusBroken=function(){t("reconnecting after "+o.reconnectTimeout+" msec.")},o.on("mbinit",r.onModbusInit),o.on("mbconnected",r.onModbusConnect),o.on("mbactive",r.onModbusActive),o.on("mberror",r.onModbusError),o.on("mbbroken",r.onModbusBroken),o.on("mbclosed",r.onModbusClose),r.on("input",function(e){var s;o.client&&e.payload&&(e.messageId=u.getObjectId(),r.bufferMessageList.set(e.messageId,e),a("Add Message "+e.messageId),e={topic:e.topic||r.id,payload:{value:e.payload.value||e.payload,unitid:r.unitid,fc:u.functionCodeModbus(r.dataType),address:r.adr,quantity:r.quantity,messageId:e.messageId},_msgid:e._msgid},o.emit("readModbus",e,r.onModbusReadDone,r.onModbusReadError),r.showStatusActivities&&(t(o.statlyMachine.getMachineState()),s=e,i.settings.verbose&&a("string"==typeof s?s:JSON.stringify(s))))}),r.onModbusReadDone=function(e,s){r.showStatusActivities&&t("reading done"),r.send(function(e,s,o){var t=u.getOriginalMessage(r.bufferMessageList,o)||o;t.payload=e,t.topic=o.topic,t.responseBuffer=s,t.input=o;var i=Object.assign({},t);if(i.payload=s,i.values=e,delete i.responseBuffer,r.useIOFile&&r.ioFile.lastUpdatedAt){var n=d.nameValuesFromIOFile(o,r.ioFile,e,s,r.adr),a=d.filterValueNames(n,u.functionCodeModbus(r.dataType),r.adr,r.quantity);return r.useIOForPayload?(t.payload=a,t.values=e):(t.payload=e,t.valueNames=a),i.valueNames=a,[t,i]}return[t,i]}(e.data,e,s))},r.onModbusReadError=function(e,s){a(e.message),n.setModbusError(r,o,e,u.getOriginalMessage(r.bufferMessageList,s)||s,t)},r.on("close",function(){t("closed")})})};
//# sourceMappingURL=maps/modbus-getter.js.map
