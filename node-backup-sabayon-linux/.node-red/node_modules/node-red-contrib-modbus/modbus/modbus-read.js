"use strict";module.exports=function(u){require("source-map-support").install();var d=require("./modbus-basics"),l=require("./core/modbus-core"),c=require("./core/modbus-io-core"),b=require("debug")("contribModbus:read");u.nodes.registerType("modbus-read",function(e){u.nodes.createNode(this,e),this.name=e.name,this.topic=e.topic,this.unitid=e.unitid,this.dataType=e.dataType,this.adr=e.adr,this.quantity=e.quantity||1,this.rate=e.rate,this.rateUnit=e.rateUnit,this.delayOnStart=e.delayOnStart,this.startDelayTime=parseInt(e.startDelayTime)||10,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.connection=null,this.useIOFile=e.useIOFile,this.ioFile=u.nodes.getNode(e.ioFile),this.useIOForPayload=e.useIOForPayload;var a=this,o=u.nodes.getNode(e.server),t=null,n=null,i=!1;function s(e){u.settings.verbose&&b("string"==typeof e?e:JSON.stringify(e))}function r(e){if("polling"!==e||!i){var t=d.setNodeStatusProperties(e,a.showStatusActivities);-1!==e.search("active")||"polling"===e?(i=!1,a.status({fill:t.fill,shape:t.shape,text:t.status+" ( "+a.rate+" "+d.get_timeUnit_name(a.rateUnit)+" ) "})):a.status({fill:t.fill,shape:t.shape,text:t.status})}}a.INPUT_TIMEOUT_MILLISECONDS=1e3,r("waiting"),a.onModbusInit=function(){r("initialize")},a.onModbusConnect=function(){a.delayOnStart?(t&&clearTimeout(t),t=setTimeout(a.startIntervalReading,a.INPUT_TIMEOUT_MILLISECONDS*a.startDelayTime)):(t&&clearTimeout(t),a.startIntervalReading()),r("connected")},a.startIntervalReading=function(){n||(n=setInterval(a.modbusPollingRead,d.calc_rateByUnit(a.rate,a.rateUnit)))},a.onModbusActive=function(){r("active")},a.onModbusError=function(e){r("failure"),n&&clearInterval(n),n=null,a.showErrors&&a.warn(e)},a.onModbusClose=function(){r("closed"),n&&clearInterval(n),n=null},a.onModbusBroken=function(){r("reconnecting after "+o.reconnectTimeout+" msec."),n&&clearInterval(n),n=null},o.on("mbinit",a.onModbusInit),o.on("mbconnected",a.onModbusConnect),o.on("mbactive",a.onModbusActive),o.on("mberror",a.onModbusError),o.on("mbbroken",a.onModbusBroken),o.on("mbclosed",a.onModbusClose),a.modbusPollingRead=function(){if(o.client){var e={topic:a.topic||"polling",from:a.name,payload:{unitid:a.unitid,fc:l.functionCodeModbus(a.dataType),address:a.adr,quantity:a.quantity,messageId:l.getObjectId()}};a.showStatusActivities&&(r("polling"),s(e)),o.emit("readModbus",e,a.onModbusReadDone,a.onModbusReadError)}else r("waiting")},a.onModbusReadDone=function(e,t){a.showStatusActivities&&(r("reading done"),s("reading done -> "+JSON.stringify(t))),function(e,t,o){if(a.useIOFile&&a.ioFile.lastUpdatedAt){c.internalDebug("node.adr:"+a.adr+" node.quantity:"+a.quantity);var n=c.nameValuesFromIOFile(o,a.ioFile,e,t,a.adr),i=c.filterValueNames(n,l.functionCodeModbus(a.dataType),a.adr,a.quantity),s={topic:o.topic,responseBuffer:t,input:o};a.useIOForPayload?(s.payload=i,s.values=e):(s.payload=e,s.valueNames=i),a.send([s,{payload:t,values:e,input:o,valueNames:i}])}else a.send([{payload:e,responseBuffer:t,input:o},{payload:t,values:e,input:o}])}(e.data,e,t)},a.onModbusReadError=function(e,t){b(e.message),d.setModbusError(a,o,e,t,r)},a.on("close",function(){n&&clearInterval(n),n=null,r("closed")})}),u.httpAdmin.post("/modbus/read/inject/:id",u.auth.needsPermission("modbus.inject.write"),function(e,t){var o=u.nodes.getNode(e.params.id);if(o)try{o.modbusPollingRead(),t.sendStatus(200)}catch(e){t.sendStatus(500),o.error(u._("modbusinject.failed",{error:e.toString()}))}else t.sendStatus(404)})};
//# sourceMappingURL=maps/modbus-read.js.map
