"use strict";module.exports=function(o){require("source-map-support").install();var a=require("./modbus-basics"),r=require("./core/modbus-core"),u=require("debug")("contribModbus:write");o.nodes.registerType("modbus-write",function(e){o.nodes.createNode(this,e),this.name=e.name,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.unitid=e.unitid,this.dataType=e.dataType,this.adr=Number(e.adr),this.quantity=e.quantity;var i=this,t=o.nodes.getNode(e.server);function s(e){o.settings.verbose&&u("string"==typeof e?e:JSON.stringify(e))}function n(e){var o=a.setNodeStatusProperties(e,i.showStatusActivities);a.statusLog&&s("status options: "+JSON.stringify(o)),i.status({fill:o.fill,shape:o.shape,text:o.status})}i.bufferMessageList=new Map,n("waiting"),i.onModbusInit=function(){n("initialize")},i.onModbusConnect=function(){n("connected")},i.onModbusActive=function(){n("active")},i.onModbusError=function(e){n("failure"),i.showErrors&&i.warn(e)},i.onModbusClose=function(){n("closed")},i.onModbusBroken=function(){n("reconnecting after "+t.reconnectTimeout+" msec.")},t.on("mbinit",i.onModbusInit),t.on("mbconnected",i.onModbusConnect),t.on("mbactive",i.onModbusActive),t.on("mberror",i.onModbusError),t.on("mbbroken",i.onModbusBroken),t.on("mbclosed",i.onModbusClose),i.on("input",function(e){if(e&&e.hasOwnProperty("payload"))return null==e.payload?(n("payload error"),void i.error(new Error("Invalid msg.payload"),e)):void(t.client&&(e.payload.hasOwnProperty("value")&&"string"==typeof e.payload.value&&("true"===e.payload.value||"false"===e.payload.value?e.payload.value="true"===e.payload.value:-1<e.payload.value.indexOf(",")&&(e.payload.value=JSON.parse(e.payload.value))),e.messageId=r.getObjectId(),i.bufferMessageList.set(e.messageId,e),u("Add Message "+e.messageId),e={payload:{value:e.payload.value||e.payload,unitid:i.unitid,fc:i.functionCodeModbus(i.dataType),address:i.adr,quantity:i.quantity,messageId:e.messageId},_msgid:e._msgid},t.emit("writeModbus",e,i.onModbusWriteDone,i.onModbusWriteError),i.showStatusActivities&&(n(t.statlyMachine.getMachineState()),s(e))))}),i.functionCodeModbus=function(e){switch(e){case"Coil":return 5;case"HoldingRegister":return 6;case"MCoils":return 15;case"MHoldingRegisters":return 16;default:return e}},i.onModbusWriteDone=function(e,o){i.showStatusActivities&&n("write done"),i.send(function(e,o,t){var s=r.getOriginalMessage(i.bufferMessageList,t)||t;s.payload=e,s.topic=t.topic,s.responseBuffer=o,s.input=t;var n=Object.assign({},s);return n.payload=o,n.values=e,delete n.responseBuffer,[s,n]}(o.payload,e,o))},i.onModbusWriteError=function(e,o){u(e.message),a.setModbusError(i,t,e,r.getOriginalMessage(i.bufferMessageList,o)||o,n)},i.on("close",function(){n("closed")})})};
//# sourceMappingURL=maps/modbus-write.js.map
