"use strict";module.exports=function(n){require("source-map-support").install();var c=require("./core/opcua-iiot-core-browser");n.nodes.registerType("OPCUA-IIoT-Browser",function(e){n.nodes.createNode(this,e),this.nodeId=e.nodeId,this.name=e.name,this.justValue=e.justValue,this.sendNodesToRead=e.sendNodesToRead,this.sendNodesToBrowser=e.sendNodesToBrowser,this.sendNodesToListener=e.sendNodesToListener,this.singleBrowseResult=e.singleBrowseResult,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.recursiveBrowse=e.recursiveBrowse,this.recursiveDepth=e.recursiveDepth||1,this.delayPerMessage=e.delayPerMessage||.2,this.connector=n.nodes.getNode(e.connector);var d=c.initClientNode(this);d.items=[],d.browseTopic=c.core.OBJECTS_ROOT,d.messageList=[],d.extractDataFromBrowserResults=function(e,s){e.forEach(function(e){e.references.forEach(function(e){c.detailDebugLog("Add Reference To List :"+e),s.browserResults.push(c.transformToEntry(e)),e.nodeId&&(s.nodesToRead.push(e.nodeId.toString()),s.addressItemList.push({nodeId:e.nodeId.toString(),browseName:e.browseName.toString(),displayName:e.displayName.toString(),nodeClass:e.nodeClass.toString(),datatypeName:e.typeDefinition.toString()}))})})},d.browse=function(o,t,r,n,i){c.core.checkSessionNotValid(d.opcuaSession,"Browse")||(c.internalDebugLog("Browse Topic To Call Browse "+o),c.browse(d.opcuaSession,o).then(function(e){if(e.length)if(c.detailDebugLog("Browser Result To String: "+e.toString()),d.extractDataFromBrowserResults(e,n),d.recursiveBrowse)if(0<r){var s=r-1;d.browseNodeList(n.addressItemList,t,s,n,i),d.singleBrowseResult||i(o,r,t,n)}else c.internalDebugLog("Minimum Depth Reached On Browse At "+o),i(o,r,t,n);else i(o,r,t,n);else c.internalDebugLog("No Browse Results On "+o)}).catch(function(e){c.browseErrorHandling(d,e,t,n)}))},d.createListsObject=function(){return{nodesToBrowse:[],nodesToRead:[],addressItemList:[],browserResults:[]}},d.browseNodeList=function(e,t,r,n,i){if(!c.core.checkSessionNotValid(d.opcuaSession,"BrowseList")){c.internalDebugLog("Browse For NodeId List");var a="list";d.opcuaSession&&c.browseAddressSpaceItems(d.opcuaSession,e).then(function(e){if(c.detailDebugLog("List Browser Result To String: "+e.toString()),d.extractDataFromBrowserResults(e,n),d.recursiveBrowse)if(0<r){var s=r-1,o=d.createListsObject();d.browseNodeList(n.addressItemList,t,s,o,i),d.singleBrowseResult||i(a,r,t,n)}else c.internalDebugLog("Minimum Depth Reached On Browse List"),i(a,r,t,n);else i(a,r,t,n)}).catch(function(e){c.browseErrorHandling(d,e,t,n)})}},d.sendMessage=function(e,s,o,t){var r=Object.assign({},o);r.nodetype="browse",r.justValue=d.justValue,t||(c.internalDebugLog("Lists Not Valid!"),d.showErrors&&d.error(new Error("Lists Not Valid On Browse Send Message"),r));var n=d.getListenParameters(r);r.payload={rootNodeId:e,browserResults:t.browserResults,recursiveBrowse:d.recursiveBrowse,recursiveDepth:s,recursiveDepthMax:d.recursiveDepth,listenerParameters:n},r=d.enhanceMessage(r,t),r=d.setMessageLists(r,t),d.messageList.push(r),d.showStatusActivities&&"active"!==d.status.text&&c.core.setNodeStatusTo(d,"active"),setTimeout(function(){d.send(d.messageList.shift())},d.delayPerMessage*c.core.FAKTOR_SEC_TO_MSEC)},d.getListenParameters=function(e){return"listen"===e.injectType?e.payload:null},d.enhanceMessage=function(e,s){return d.justValue?e.payload.browserResults=s.addressItemList:(e.payload.browseTopic=d.browseTopic,e.payload.addressSpaceItems=e.addressSpaceItems,e.payload.browserResultsCount=s.browserResults.length,d.connector&&(e.payload.endpoint=d.connector.endpoint),e.payload.session=d.opcuaSession?d.opcuaSession.name:"none"),e},d.setMessageLists=function(e,s){return d.sendNodesToRead&&s.nodesToRead&&(e.nodesToRead=s.nodesToRead,e.nodesToReadCount=s.nodesToRead.length),d.sendNodesToListener&&s.addressItemList&&(e.addressItemsToRead=s.addressItemList,e.addressItemsToReadCount=s.addressItemList.length),d.sendNodesToBrowser&&s.addressItemList&&(e.addressItemsToBrowse=s.addressItemList,e.addressItemsToBrowseCount=s.addressItemList.length),e},d.browseSendResult=function(e,s,o,t){c.internalDebugLog(e+" called by depth "+s),d.singleBrowseResult?s<=0&&(d.sendMessage(e,s,o,t),d.reset(t)):(d.sendMessage(e,s,o,t),d.reset(t))},d.reset=function(e){d.createListsObject()},d.browseWithAddressSpaceItems=function(e,s,o){e.addressItemsToBrowse&&0<e.addressItemsToBrowse.length&&(e.addressSpaceItems=e.addressItemsToBrowse),e.addressSpaceItems&&0<e.addressSpaceItems.length?d.browseNodeList(e.addressSpaceItems,e,s,o,function(e,s,o,t){d.browseSendResult(e,s,o,t)}):(c.detailDebugLog("Fallback NodeId On Browse Without AddressSpace Items"),d.browseTopic=d.nodeId||c.browseToRoot(),d.browse(d.browseTopic,e,s,o,function(e,s,o,t){d.browseSendResult(e,s,o,t)}))},d.startBrowser=function(e){if(!c.core.checkSessionNotValid(d.opcuaSession,"Browser")){var s=d.createListsObject(),o=d.recursiveBrowse?d.recursiveDepth:0;d.browseTopic=c.extractNodeIdFromTopic(e,d),d.browseTopic&&""!==d.browseTopic?d.browse(d.browseTopic,e,o,s,function(e,s,o,t){d.browseSendResult(e,s,o,t)}):d.browseWithAddressSpaceItems(e,o,s)}},d.on("input",function(e){c.core.checkConnectorState(d,e,"Browser")&&(d.showStatusActivities&&c.core.setNodeStatusTo(d,"browsing"),d.startBrowser(e))}),c.core.registerToConnector(d),d.on("close",function(e){c.core.deregisterToConnector(d,e)})}),n.httpAdmin.get("/opcuaIIoT/browse/:id/:nodeId",n.auth.needsPermission("opcuaIIoT.browse"),function(e,s){var o=n.nodes.getNode(e.params.id),t=[],r=decodeURIComponent(e.params.nodeId)||c.core.OBJECTS_ROOT;c.detailDebugLog("request for "+e.params.nodeId),o.opcuaSession?c.browse(o.opcuaSession,r).then(function(e){e.forEach(function(e){e.references&&e.references.length&&e.references.forEach(function(e){t.push(c.transformToEntry(e))})}),s.json(t)}).catch(function(e){c.internalDebugLog("Browser Error "+e),o.showErrors&&o.error(e,{payload:"Browse Internal Error"}),t.push({displayName:{text:"Objects"},nodeId:c.core.OBJECTS_ROOT,browseName:"Objects"}),s.json(t)}):s.json(t)})};
//# sourceMappingURL=maps/opcua-iiot-browser.js.map
