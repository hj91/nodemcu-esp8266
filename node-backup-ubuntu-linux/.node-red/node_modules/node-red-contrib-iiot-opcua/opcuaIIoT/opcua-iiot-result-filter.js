"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}module.exports=function(t){require("source-map-support").install();var a=require("./core/opcua-iiot-core-filter"),r=require("underscore");t.nodes.registerType("OPCUA-IIoT-Result-Filter",function(e){t.nodes.createNode(this,e),this.nodeId=e.nodeId,this.datatype=e.datatype,this.fixedValue=e.fixedValue,this.fixPoint=2|parseInt(e.fixPoint),this.withPrecision=e.withPrecision,this.precision=2|parseInt(e.precision),this.entry=e.entry,this.justValue=e.justValue,this.withValueCheck=e.withValueCheck,this.minvalue=e.minvalue,this.maxvalue=e.maxvalue,this.defaultvalue=e.defaultvalue,this.topic=e.topic,this.name=e.name,this.showErrors=e.showErrors;var n=this;n.subscribed=!1,n.withValueCheck&&(n.minvalue=n.convertDataType(n.minvalue),n.maxvalue=n.convertDataType(n.maxvalue)),n.status({fill:"blue",shape:"ring",text:"new"}),n.nodeIdToFilter=function(e){var t=!0,r=a.core.buildNodeListFromClient(e);return r&&r.length&&(t=!r.some(function(e,t,r){return(e.nodeId||e).toString()===n.nodeId.toString()})),t},n.isNodeIdToFindInsideMsg=function(e){if(e.addressSpaceItems){if(r.filter(e.addressSpaceItems,function(e){return e.nodeId===n.nodeId}).length<1)return!0}else if(e.topic!==n.nodeId)return!0},n.messageIsToFilter=function(e){return!!n.nodeIdToFilter(e)||n.isNodeIdToFindInsideMsg(e)},n.on("input",function(e){if(e.hasOwnProperty("payload")&&null!==e.payload&&void 0!==e.payload)if(n.messageIsToFilter(e))a.internalDebugLog("filtering message on filter");else{var t=Object.assign({},e),r=n.filterResult(t);n.justValue?n.send({payload:r,topic:n.topic||t.topic,nodeId:n.nodeId,justValue:n.justValue}):n.send({payload:r,topic:n.topic||t.topic,nodeId:n.nodeId,input:t,justValue:n.justValue})}else a.internalDebugLog("filtering message without payload")}),n.filterByType=function(e){var t=null;switch(e.nodetype){case"read":t=n.filterByReadType(e);break;case"write":t=n.filterByWriteType(e);break;case"listen":t=n.filterByListenType(e);break;case"browse":case"crawl":t=n.filterByBrowserType(e);break;default:a.internalDebugLog("unknown node type injected to filter for "+e.nodetype),n.showErrors&&n.error(new Error("unknown node type injected to filter for "+e.nodetype),e)}return t},n.convertResult=function(t,r){try{var e=null;return 0<=n.fixPoint&&n.fixedValue&&(e=Number.parseFloat(r).toFixed(n.fixPoint),e=parseFloat(e)),0<=n.precision&&n.withPrecision&&(e=Number.parseFloat(r).toPrecision(n.precision),e=parseFloat(e)),n.withValueCheck&&(e<n.minvalue||e>n.maxvalue)&&(e=n.defaultvalue),e}catch(e){return a.internalDebugLog("result converting error "+e.message),n.showErrors&&n.error(e,t),r}},n.convertResultByDataType=function(e,t){var r=_typeof(t);return t.hasOwnProperty("datatype")&&(r=t.datatype||r),r&&r.toString()!==n.datatype.toString()&&(t=n.convertDataType(t)),t},n.convertResultValue=function(e,t){if(null!=t)return t.hasOwnProperty("value")&&(t=t.value),null==(t=n.convertResultByDataType(e,t))?(a.internalDebugLog("converted result null or undefined"),n.showErrors&&n.error(new Error("converted result null or undefined"),e)):t=n.convertResult(e,t),t;a.internalDebugLog("result null or undefined")},n.filterResult=function(e){e.filtertype="filter";var t=n.filterByType(e)||e.payload;return"read"!==e.nodetype&&"listen"!==e.nodetype||(t=n.convertResultValue(e,t)),t},n.extractValueFromOPCUAArrayStructure=function(e,t){var r=null,n=e.payload[t];return n?r=n.hasOwnProperty("value")?n.value.hasOwnProperty("value")?n.value.value:n.value:n:r},n.extractValueFromOPCUAStructure=function(e){return e.payload.hasOwnProperty("value")?e.payload.value.hasOwnProperty("value")?e.payload.value.value:e.payload.value:e.payload},n.filterByReadType=function(e){var t=null;return(t=e.payload.length>=n.entry?n.extractValueFromOPCUAArrayStructure(e,n.entry-1):n.extractValueFromOPCUAStructure(e)).hasOwnProperty("value")&&(t=t.value),t},n.filterByWriteType=function(e){return null},n.filterByListenType=function(e){var t=null;return(t=e.payload&&e.payload.hasOwnProperty("value")?e.payload.value:e.payload)&&t.hasOwnProperty("value")&&(t=t.value),t},n.filterByBrowserType=function(e){return null},n.convertDataType=function(e){return a.internalDebugLog("data type convert for "+n.nodeId),a.core.convertDataValueByDataType({value:e},n.datatype)},n.status({fill:"green",shape:"dot",text:"active"})})};
//# sourceMappingURL=maps/opcua-iiot-result-filter.js.map
