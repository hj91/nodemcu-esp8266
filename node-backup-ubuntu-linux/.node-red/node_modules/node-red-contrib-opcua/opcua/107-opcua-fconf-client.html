<!--

Copyright 2017 Valmet Automation Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

-->

<script type="text/x-red" data-template-name="OPCUA endpoint">
    <div class="form-row">
		<ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-config-OPCUA-endpoint-tabs"></ul>
	</div>
	<div id="node-config-OPCUA-endpoint-tabs-content" style="min-height: 170px;">
		<div id="OPCUA-endpoint-tab-connection" style="display:none">
			<div class="form-row">
				<label for="node-config-input-address"><i class="fa fa-globe"></i> <span data-i18n="OPCUA.endpoint.label.address"></span></label>
				<input class="input-append-left" type="text" id="node-config-input-address" data-i18n="[placeholder]OPCUA.endpoint.label.address" style="width: 40%;">
				<label for="node-config-input-port" style="margin-left: 10px; width: 35px; "> <span data-i18n="OPCUA.endpoint.label.port"></span></label>
				<input type="text" id="node-config-input-port" data-i18n="[placeholder]OPCUA.endpoint.label.port" style="width: 50px">
			</div>
			<div class="form-row">
				<label for="node-config-input-interval"><i class="fa fa-refresh"></i> <span data-i18n="OPCUA.endpoint.label.interval"></span></label>
				<input type="text" id="node-config-input-interval" data-i18n="[placeholder]OPCUA.endpoint.label.interval" style="width: 60px;"> <span>ms</span>
			</div>
			<div class="form-row">
				<label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="OPCUA.label.name"></span></label>
				<input type="text" id="node-config-input-name" data-i18n="[placeholder]OPCUA.label.name">
			</div>
		</div>
		<div id="OPCUA-endpoint-tab-items" style="display:none">
			<div class="form-row" style="margin-bottom:0;">
				<label><i class="fa fa-list"></i> <span data-i18n="OPCUA.endpoint.label.items.list"></span></label>
			</div>
			<div class="form-row node-input-items-container-row" style="margin-bottom: 0px;">
				<div id="node-config-input-items-container-div" style="box-sizing: border-box; border-radius: 5px; height: 300px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;">
					<ol id="node-config-input-items-container" style=" list-style-type:none; margin: 0;"></ol>
				</div>
			</div>
			<div class="form-row">
				<a href="#" class="editor-button editor-button-small" id="node-config-OPCUA-endpoint-var-export" style="margin: 4px; float: right"><i class="fa fa-download"></i> <span data-i18n="OPCUA.endpoint.label.items.export"></span></a>
				<input type="file" id="node-config-OPCUA-endpoint-var-import" style="display: none"/>
				<a href="#" class="editor-button editor-button-small" id="node-config-OPCUA-endpoint-var-import-btn" style="margin: 4px; float: right"><i class="fa fa-upload"></i> <span data-i18n="OPCUA.endpoint.label.items.import"></span></a>
				<a href="#" class="editor-button editor-button-small" id="node-config-input-add-variable" style="margin: 4px;"><i class="fa fa-plus"></i> <span data-i18n="OPCUA.endpoint.label.items.add"></span></a>
				<a href="#" class="editor-button editor-button-small" id="node-config-OPCUA-endpoint-var-clean" style="margin: 4px;"><i class="fa fa-trash-o"></i> <span data-i18n="OPCUA.endpoint.label.items.clean"></span></a>
			</div>
			<!--<input type="hidden" id="node-config-input-vartable">-->
		</div>
	</div>
</script>

<script type="text/x-red" data-help-name="OPCUA endpoint">
	<p>OPCUA Server endpoint like opc.tcp://localhost:26543</p>
</script>

<script type="text/javascript">
	/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
	var saveAs=saveAs||function(e){"use strict";if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,a=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s="application/octet-stream",d=1e3*40,c=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,d)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(a){u(a)}}}},p=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,d){if(!d){t=p(t)}var v=this,w=t.type,m=w===s,y,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&i)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");var n=e.open(t,"_blank");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,"_blank");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;a(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||"download";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!==null){define("FileSaver.js",function(){return saveAs})}
</script>

<script type="text/javascript">
	RED.nodes.registerType('OPCUA endpoint', {
		category: 'opcua',
        color: "#3FADB5",
		defaults: {
			address: {
				value: "",
				validate: RED.validators.regex(/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/)
			},
			port: {
				value: "26543",
				validate: RED.validators.number()
			},
			interval: {
				value: 100
			},
			timeout: {
				value: 120000
			},
			name: {
				value: ""
			},
			vartable: {
				value: [{
					item: "",
					type: ""
				}]
			}
		},
		label: function() {
			return this.name || this.address + ":" + this.port;
		},
		oneditprepare: function() {
			var self = this;
			var labelItem = this._("OPCUA.endpoint.label.items.item");
			var labelType = this._("OPCUA.endpoint.label.items.type");
			var labelDel = this._("OPCUA.endpoint.label.items.del");

			// Prepare tabs
			var tabs = RED.tabs.create({
				id: "node-config-OPCUA-endpoint-tabs",
				onchange: function(tab) {
					$("#node-config-OPCUA-endpoint-tabs-content").children().hide();
					$("#" + tab.id).show();
				}
			});
			tabs.addTab({
				id: "OPCUA-endpoint-tab-connection",
				label: this._("OPCUA.endpoint.label.tabs.connection")
			});
			tabs.addTab({
				id: "OPCUA-endpoint-tab-items",
				label: this._("OPCUA.endpoint.label.tabs.items")
			});
			setTimeout(function() {
				tabs.resize()
			}, 0);

			function generateVariable(variable) {
				var container = $('<li/>', {
					style: "background: #fff; margin:0; padding:8px 0px; border-bottom: 1px solid #ccc;"
				});
				var row1 = $('<div/>').appendTo(container);

				var variableItem = $('<input/>', {
					style: "width: 110px; margin-right: 10px;",
					class: "node-config-input-variable-item",
					type: "text",
					placeholder: labelItem
				}).appendTo(row1);

				var variableType = $('<input/>', {
					style: "width: 250px",
					class: "node-config-input-variable-type",
					type: "text",
					placeholder: labelType
				}).appendTo(row1);

				var finalspan = $('<span/>', {
					style: "float: right; margin-right: 10px;"
				}).appendTo(row1);
				var deleteButton = $('<a/>', {
					href: "#",
					class: "editor-button editor-button-small",
					style: "margin-top: 7px; margin-left: 5px;",
					title: labelDel
				}).appendTo(finalspan);

				$('<i/>', {
					class: "fa fa-remove"
				}).appendTo(deleteButton);

				deleteButton.click(function() {
					container.css({
						"background": "#fee"
					});
					container.fadeOut(150, function() {
						$(this).remove();
					});
				});

				//populate data
				variableItem.val(variable.item);
				variableType.val(variable.type);

				$("#node-config-input-items-container").append(container);
			}

			function cleanVarTable() {
				$("#node-config-input-items-container").children().remove();
			}

			function populateVarTable() {
				if(self.vartable) {
					if(typeof self.vartable == 'string') {
						self.vartable = JSON.parse(self.vartable);
					}
					for (var i = 0; i < self.vartable.length; i++) {
						generateVariable(self.vartable[i]);
					}
				}
			}

			$("#node-config-input-add-variable").click(function() {
				generateVariable({
					item: "",
					type: ""
				});
			});

			$("#node-config-input-interval").spinner({
				min: 50
			});

			$("#node-config-input-timeout").spinner({
				min: 500
			});

			$("#node-config-OPCUA-endpoint-var-clean").click(cleanVarTable);

			populateVarTable();

			// export
			function exportCSV(){
				var vars = $("#node-config-input-items-container").children();
				var lines = [];

				vars.each(function(i) {
					var elm = $(this);
					lines.push([
						elm.find(".node-config-input-variable-item").val(),
						elm.find(".node-config-input-variable-type").val()
					].join(';'));
				});

				saveAs(new Blob([lines.join('\r\n')]), 'OPCUAendpoint' + (self.name ? '_' + self.name : '') + '.csv');
			}
			$('#node-config-OPCUA-endpoint-var-export').click(exportCSV);

			// import
			function importCSV(e) {
				var file = e.target.files[0];
				if (!file) {
					return;
				}
				var reader = new FileReader();
				reader.onload = function(e) {
					var res = [], i, fields;
					var contents = e.target.result || '';
					var lines = contents.split(/[\r\n]+/);
					
					if(!lines.length) {
						alert('file is empty!');
						return;
					}

					for(i = 0; i < lines.length; i++){
						
						lines[i] = lines[i].trim();
						if(lines[i] == '') continue;

						fields = lines[i].split(/[\t;]/);

						if(fields.length < 2) {
							alert('line must have at least two parameters, item and type');
							return;
						}
						res.push({
							item: fields[0],
							type: fields[1]
						});
					}

					if(res.length) {
						cleanVarTable();
						self.vartable = res;
						populateVarTable();
					}
				};
				reader.readAsText(file);
			}
			$('#node-config-OPCUA-endpoint-var-import').on('change', importCSV);
			$('#node-config-OPCUA-endpoint-var-import-btn').click(function() {
				$('#node-config-OPCUA-endpoint-var-import').click();
			})
			
		},
		oneditsave: function() {
			var node = this;
			var vars = $("#node-config-input-items-container").children();
			node.vartable = [];

			vars.each(function(i) {
				var elm = $(this);
				var v = {
					item: elm.find(".node-config-input-variable-item").val(),
					type: elm.find(".node-config-input-variable-type").val()
				}
				node.vartable.push(v);
			});
			//$('#node-config-input-vartable').val(JSON.stringify(node.vartable));
		}/*,
		oneditresize: function(size) {
			var rows = $("#OPCUA-endpoint-tab-items>div:not(.form-row node-input-items-container-row)");
			var height = size.height;
			for (var i = 0; i < rows.size(); i++) {
				height -= $(rows[i]).outerHeight(true);
			}
			var editorRow = $("#OPCUA-endpoint-tab-items>div.form-row node-input-items-container-row");
			height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
			$("#node-config-input-items-container-div").css("height", height + "px");

			var rules = $("#node-config-input-items-container").children();
			var newWidth = $("#node-config-input-items-container").width();
			rules.each(function(i) {
				$(this).find('.node-config-input-variable-name').typedInput("width", newWidth - 180);
			});
		}*/
	});
	//# sourceURL=OPCUAEndpointScript.js
</script>

<!-- ######################################################################################## -->

<script type="text/x-red" data-template-name="OPCUA in">
	<div class="form-row">
		<label for="node-input-endpoint"><i class="fa fa-bolt"></i> <span data-i18n="OPCUA.in.label.endpoint"></span></label>
		<input type="text" id="node-input-endpoint" data-i18n="[placeholder]OPCUA.in.label.endpoint">
	</div>
	<div class="form-row">
		<label for="node-input-mode"><i class="fa fa-sliders"></i> <span data-i18n="OPCUA.in.label.mode"></span></label>
		<select type="text" id="node-input-mode">
			<option value="single" data-i18n="OPCUA.in.mode.single"></option>
			<option value="all-split" data-i18n="OPCUA.in.mode.all-split"></option>
			<option value="all" data-i18n="OPCUA.in.mode.all"></option>
		</select>
	</div>
	<div class="form-row OPCUA-input-var-row">
		<label for="node-input-variable"><i class="fa fa-random"></i> <span data-i18n="OPCUA.in.label.variable"></span></label>
		<select type="text" id="node-input-variable">
		</select>
    <span id="OPCUA-custom-var-addr"></span>
	</div>
	<div class="form-row">
		<label>&nbsp;</label>
		<input type="checkbox" id="node-input-diff" style="display: inline-block; width: auto; vertical-align: top;">
		<label for="node-input-diff" style="width:70%;"><span data-i18n="OPCUA.in.label.diff"></span></label>
	</div>
	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="OPCUA.label.name"></span></label>
		<input type="text" id="node-input-name" data-i18n="[placeholder]OPCUA.label.name">
	</div>
</script>

<script type="text/x-red" data-help-name="OPCUA in">
	<p>Reads data from a OPCUA Server (uses subscription)</p>
	<p>All data is read with subscription interval from the OPCUA Server as configured in the <i>OPCUA endpoint</i>, but there are three modes of making it available in a flow:</p>
	<ul>
		<li><b>Single variable:</b> A single variable can be selected from the configured items, and a message is sent every cycle, or only when it changes if <i>diff</i> is checked. <code>msg.payload</code> contains the variable's value and <code>msg.topic</code> has the variable's name.</li>
		<li><b>All items, one per message:</b> Like the <i>Single variable</i> mode, but for all items configured. If <i>diff</i> is checked, a message is sent everytime any variable changes. If <i>diff</i> is unchecked, one message is sent for every variable, in every cycle. Care must be taken about the number of messages per second in this mode.</li>
		<li><b>All items:</b> In this mode, <code>msg.payload</code> contains an object with all configured items and their values. If <i>diff</i> is checked, a message is sent if at least one of the items changes its value.</li>
	</ul>
</script>

<script type="text/javascript">
	RED.nodes.registerType('OPCUA in', {
		category: 'opcua',
        color: "#3FADB5",
		defaults: {
			endpoint: {
				value: "",
				type: "OPCUA endpoint",
				required: true
			},
			mode: {
				value: "single"
			},
			variable: {
				value: ""
			},
			diff: {
				value: true
			},
			name: {
				value: ""
			}
		},
		inputs: 0,
		outputs: 1,
		icon: "serial.png",
		label: function() {
			var self = this;

			if (this.name) return this.name;

			var endpointNode = RED.nodes.node(this.endpoint);
			if (endpointNode) {
				return (this.mode == 'single' ? this.variable : null) || endpointNode.label();
			}
			return this._("OPCUA.in.label.name");
		},
		labelStyle: function() {
			return this.name ? "node_label_italic" : "";
		},
		oneditprepare: function() {
			var self = this;

			var varList = $('#node-input-variable');
			var varAddr = $('#OPCUA-custom-var-addr');
			var modeList = $('#node-input-mode');
			var endpointList = $("#node-input-endpoint");
			var vars = [];

			function updateVarList(endpointId) {
				$('#node-input-variable option').remove();

				var endpointNode = RED.nodes.node(endpointId);
				if (!endpointNode) return;
				vars = endpointNode.vartable || [];
				if (typeof vars === 'string') vars = JSON.parse(vars);

				varList.append($('<option/>', {
					disabled: "disabled",
					selected: "selected",
					style: "display:none;",
					text: vars.length ? self._("OPCUA.in.label.variable-select") : self._("OPCUA.in.label.variable-novar")
				}));

				$.each(vars, function(i, val) {
					varList.append($('<option/>', {
						value: val.item || val.type,
						text: val.item || val.type
					}));
					if(val.name == self.variable) {
						varList.val(self.variable);
					}
				});
			}

			varList.change(function() {
				$.each(vars, function(i, val) {
					if(varList.val() == val.item) {
						varAddr[0].innerText = val.type;
						return true;
					}
				});
			});

			endpointList.change(function() {
				updateVarList(endpointList.val());
			});
			updateVarList(self.endpoint);

			modeList.change(function() {
				if (modeList.val() == "single") {
					varList.parent().show();
				} else {
					varList.parent().hide();
				}
			});
			modeList.change();
		}
	});
</script>

<!-- ######################################################################################## -->

<script type="text/x-red" data-template-name="OPCUA out">
	<div class="form-row">
		<label for="node-input-endpoint"><i class="fa fa-bolt"></i> <span data-i18n="OPCUA.out.label.endpoint"></span></label>
		<input type="text" id="node-input-endpoint" data-i18n="[placeholder]OPCUA.out.label.endpoint">
	</div>
	<div class="form-row OPCUA-input-var-row">
		<label for="node-input-variable"><i class="fa fa-random"></i> <span data-i18n="OPCUA.out.label.variable"></span></label>
		<select type="text" id="node-input-variable">
		</select>
    <span id="OPCUA-custom-var-addr"></span>
	</div>
	<div class="form-row">
		<label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="OPCUA.label.name"></span></label>
		<input type="text" id="node-input-name" data-i18n="[placeholder]OPCUA.label.name">
	</div>
	<div class="form-tips"><span data-i18n="[html]OPCUA.out.disclaimer"></span></div>
</script>

<script type="text/x-red" data-help-name="OPCUA out">
	<p>Writes <code>msg.payload</code> to the OPCUA Server</p>
  <p>The variable name can be configured in the node and takes precedence. If left blank it should be set by <code>msg.topic</code> on the incoming message.</p>
	<p><b>Warning:</b> Caution when writing data to production OPCUA Server!</p>
</script>

<script type="text/javascript">
	RED.nodes.registerType('OPCUA out', {
		category: 'opcua',
        color: "#3FADB5",
		defaults: {
			endpoint: {
				value: "",
				type: "OPCUA endpoint",
				required: true
			},
			variable: {
				value: ""
			},
			name: {
				value: ""
			}
		},
		inputs: 1,
		outputs: 0,
		icon: "serial.png",
		align: 'right',
		label: function() {
			var self = this;

			if (this.name) return this.name;

			var endpointNode = RED.nodes.node(this.endpoint);
			if (endpointNode) {
				return this.variable || endpointNode.label();
			}
			return this._("OPCUA.out.label.name");
		},
		labelStyle: function() {
			return this.name ? "node_label_italic" : "";
		},
		oneditprepare: function() {
			var self = this;

			var varList = $('#node-input-variable');
			var varAddr = $('#OPCUA-custom-var-addr')[0];
			var endpointList = $("#node-input-endpoint");
			var vars = [];

			function updateVarList(endpointId) {
				$('#node-input-variable option').remove();

				varList.append($('<option/>', {
					//disabled: "disabled",
					selected: "selected",
					//style: "display:none;",
					text: self._("OPCUA.out.label.variable-select"),
					value: ""
				}));

				var endpointNode = RED.nodes.node(endpointId);
				if (!endpointNode) return;
				vars = endpointNode.vartable || [];
				if (typeof vars === 'string') vars = JSON.parse(vars);

				$.each(vars, function(i, val) {
					varList.append($('<option/>', {
						value: val.item || val.type,
						text: val.item || val.type
					}));
					if(val.name == self.variable) {
						varList.val(self.variable);
					}
				});
			}

			varList.change(function() {
				varAddr.innerText = ""
				$.each(vars, function(i, val) {
					if(varList.val() == val.item) {
						varAddr.innerText = val.type;
						return true;
					}
				});
			});

			endpointList.change(function() {
				updateVarList(endpointList.val());
			});
			updateVarList(self.endpoint);
		}
	});
</script>
