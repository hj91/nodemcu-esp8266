"use strict";require("source-map-support").install();var de=de||{biancoroyal:{opcua:{iiot:{core:{listener:{}}}}}};de.biancoroyal.opcua.iiot.core.listener.core=de.biancoroyal.opcua.iiot.core.listener.core||require("./opcua-iiot-core"),de.biancoroyal.opcua.iiot.core.listener.client=de.biancoroyal.opcua.iiot.core.listener.client||require("./opcua-iiot-core-client"),de.biancoroyal.opcua.iiot.core.listener.internalDebugLog=de.biancoroyal.opcua.iiot.core.listener.internalDebugLog||require("debug")("opcuaIIoT:listener"),de.biancoroyal.opcua.iiot.core.listener.detailDebugLog=de.biancoroyal.opcua.iiot.core.listener.detailDebugLog||require("debug")("opcuaIIoT:listener:details"),de.biancoroyal.opcua.iiot.core.listener.subscribeDebugLog=de.biancoroyal.opcua.iiot.core.listener.subscribeDebugLog||require("debug")("opcuaIIoT:listener:subscribe"),de.biancoroyal.opcua.iiot.core.listener.subscribeDetailDebugLog=de.biancoroyal.opcua.iiot.core.listener.subscribeDetailDebugLog||require("debug")("opcuaIIoT:listener:subscribe:details"),de.biancoroyal.opcua.iiot.core.listener.eventDebugLog=de.biancoroyal.opcua.iiot.core.listener.eventDebugLog||require("debug")("opcuaIIoT:listener:event"),de.biancoroyal.opcua.iiot.core.listener.eventDetailDebugLog=de.biancoroyal.opcua.iiot.core.listener.eventDetailDebugLog||require("debug")("opcuaIIoT:listener:event:details"),de.biancoroyal.opcua.iiot.core.listener.SUBSCRIBE_DEFAULT_INTERVAL=1e3,de.biancoroyal.opcua.iiot.core.listener.MIN_LISTENER_INTERVAL=100,de.biancoroyal.opcua.iiot.core.listener.MAX_LISTENER_INTERVAL=36e5,de.biancoroyal.opcua.iiot.core.listener.SUBSCRIBE_DEFAULT_QUEUE_SIZE=1,de.biancoroyal.opcua.iiot.core.listener.EVENT_DEFAULT_INTERVAL=250,de.biancoroyal.opcua.iiot.core.listener.EVENT_DEFAULT_QUEUE_SIZE=1e4,de.biancoroyal.opcua.iiot.core.listener.METHOD_TYPE="ns=0;i=0",de.biancoroyal.opcua.iiot.core.listener.RUNNING_STATE="STARTED",de.biancoroyal.opcua.iiot.core.listener.Stately=de.biancoroyal.opcua.iiot.core.listener.Stately||require("stately.js"),de.biancoroyal.opcua.iiot.core.listener.createStatelyMachine=function(){return de.biancoroyal.opcua.iiot.core.listener.Stately.machine({IDLE:{requestinitsub:"REQUESTED",endsub:"END"},REQUESTED:{initsub:"INIT"},INIT:{startsub:"STARTED",terminatesub:"TERMINATED",errorsub:"ERROR"},STARTED:{terminatesub:"TERMINATED",errorsub:"ERROR"},TERMINATED:{idlesub:"IDLE",errorsub:"ERROR",endsub:"END"},ERROR:{idlesub:"IDLE",initsub:"INIT",endsub:"END"},END:{}},"IDLE")},de.biancoroyal.opcua.iiot.core.listener.getEventSubscribtionParameters=function(e){return{requestedPublishingInterval:e||100,requestedLifetimeCount:12e5,requestedMaxKeepAliveCount:120,maxNotificationsPerPublish:200,publishingEnabled:!0,priority:2}},de.biancoroyal.opcua.iiot.core.listener.getSubscriptionParameters=function(e){return{requestedPublishingInterval:e||200,requestedLifetimeCount:6e5,requestedMaxKeepAliveCount:60,maxNotificationsPerPublish:100,publishingEnabled:!0,priority:10}},de.biancoroyal.opcua.iiot.core.listener.collectAlarmFields=function(e,o,t){return{field:e,dataType:o,value:t}},de.biancoroyal.opcua.iiot.core.listener.getBasicEventFields=function(){return["EventId","SourceName","Message","ReceiveTime"]},de.biancoroyal.opcua.iiot.core.listener.getAllEventFields=function(){return["ConditionName","ConditionType","ConditionClassId","ConditionClassName","ConditionVariableType","SourceNode","BranchId","EventType","Severity","Retain","Comment","Comment.SourceTimestamp","EnabledState","EnabledState.Id","EnabledState.EffectiveDisplayName","EnabledState.TransitionTime","LastSeverity","LastSeverity.SourceTimestamp","Quality","Quality.SourceTimestamp","Time","ClientUserId","AckedState","AckedState.Id","ConfirmedState","ConfirmedState.Id","LimitState","LimitState.Id","ActiveState","ActiveState.Id"]},de.biancoroyal.opcua.iiot.core.listener.getStateFields=function(){return["ConditionName","SourceNode","Quality","Time","EnabledState","EnabledState.Id","EnabledState.EffectiveDisplayName","EnabledState.TransitionTime","AckedState","AckedState.Id","ConfirmedState","ConfirmedState.Id","LimitState","LimitState.Id","ActiveState","ActiveState.Id"]},de.biancoroyal.opcua.iiot.core.listener.getConditionFields=function(){return["Time","Quality","BranchId","SourceNode","ConditionName","ConditionType","ConditionClassId","ConditionClassName","ConditionVariableType"]},de.biancoroyal.opcua.iiot.core.listener.monitorItems=function(o,t,e){var i=de.biancoroyal.opcua.iiot.core.listener,r=!0,n=!1,a=void 0;try{for(var c,s=t.addressSpaceItems[Symbol.iterator]();!(r=(c=s.next()).done);r=!0){var d=c.value;if(!d.nodeId)return void i.subscribeDebugLog("Address Space Item Not Valid to Monitor "+d);if(d.datatypeName===de.biancoroyal.opcua.iiot.core.listener.METHOD_TYPE)return void i.subscribeDebugLog("Address Space Item Not Allowed to Monitor "+d);var l="string"==typeof d.nodeId?d.nodeId:d.nodeId.toString();l&&(i.subscribeDebugLog("Monitored Item Subscribing "+l),this.buildNewMonitoredItem(l,t,e).then(function(e){e.monitoredItem.monitoredItemId&&(i.subscribeDebugLog("Monitored Item Subscribed Id:"+e.monitoredItem.monitoredItemId+" to "+e.nodeId),o.monitoredASO.set(e.nodeId.toString(),{monitoredItem:e.monitoredItem,topic:t.topic||o.topic}))}).catch(function(e){i.subscribeDebugLog(e),o.showErrors&&o.error(e,t)}))}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}},de.biancoroyal.opcua.iiot.core.listener.buildNewMonitoredItem=function(n,a,c){var s=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(t,i){if(n){var e,o,r=a.payload.listenerParameters?a.payload.listenerParameters:a.payload;e="number"==typeof r.interval&&r.interval<=s.MAX_LISTENER_INTERVAL&&r.interval>=s.MIN_LISTENER_INTERVAL?parseInt(r.interval):s.SUBSCRIBE_DEFAULT_INTERVAL,o=r.queueSize&&"number"==typeof r.queueSize?parseInt(r.queueSize):s.SUBSCRIBE_DEFAULT_QUEUE_SIZE,c.monitor({nodeId:s.core.nodeOPCUA.resolveNodeId(n),attributeId:s.core.nodeOPCUA.AttributeIds.Value},{samplingInterval:e,discardOldest:!0,queueSize:o},s.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(s.internalDebugLog("subscribing monitored item "+e),i(e)):t({nodeId:n,monitoredItem:o})})}else i(new Error("NodeId Is Not Valid"))})},de.biancoroyal.opcua.iiot.core.listener.buildNewMonitoredItemGroup=function(e,c,s,d){var l=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(t,i){if(s){var e,o,r=c.payload.listenerParameters?c.payload.listenerParameters:c.payload;e="number"==typeof r.interval&&r.interval<=l.MAX_LISTENER_INTERVAL&&r.interval>=l.MIN_LISTENER_INTERVAL?parseInt(r.interval):l.SUBSCRIBE_DEFAULT_INTERVAL,o=r.queueSize&&"number"==typeof r.queueSize?parseInt(r.queueSize):l.SUBSCRIBE_DEFAULT_QUEUE_SIZE;var n=s.filter(function(e){return e.datatypeName!==de.biancoroyal.opcua.iiot.core.listener.METHOD_TYPE}),a=[];n.forEach(function(e){a.push({nodeId:l.core.nodeOPCUA.resolveNodeId(e.nodeId),attributeId:l.core.nodeOPCUA.AttributeIds.Value})}),d.monitorItems(a,{samplingInterval:e,discardOldest:!0,queueSize:o},l.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(l.internalDebugLog("subscribing monitored item group "+e),i(e)):t({addressSpaceItems:s,monitoredItemGroup:o})})}else i(new Error("NodeId Is Not Valid"))})},de.biancoroyal.opcua.iiot.core.listener.buildNewEventItem=function(r,n,a){var c=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(t,i){var e,o;r?(e="number"==typeof n.payload.interval&&n.payload.interval<c.MAX_LISTENER_INTERVAL?parseInt(n.payload.interval):c.EVENT_DEFAULT_INTERVAL,o="number"==typeof n.payload.queueSize?parseInt(n.payload.queueSize):c.EVENT_DEFAULT_QUEUE_SIZE,a.monitor({nodeId:c.core.nodeOPCUA.resolveNodeId(r),attributeId:c.core.nodeOPCUA.AttributeIds.EventNotifier},{samplingInterval:e,discardOldest:!0,queueSize:o,filter:n.payload.eventFilter},c.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(c.internalDebugLog("subscribing event item "+e),i(e)):t({nodeId:r,monitoredItem:o})})):i(new Error("NodeId Is Not Valid"))})},de.biancoroyal.opcua.iiot.core.listener.getAllEventTypes=function(o){return new Promise(function(i,r){if(o){var n=[],e=[{nodeId:(0,this.core.nodeOPCUA.makeNodeId)(this.core.nodeOPCUA.ObjectTypeIds.BaseEventType),referenceTypeId:this.core.nodeOPCUA.resolveNodeId("HasSubtype"),browseDirection:this.core.nodeOPCUA.BrowseDirection.Forward,includeSubtypes:!0,nodeClassMask:this.core.nodeOPCUA.NodeClassMask.ObjectType,resultMask:63}];o.browse(e,function(e,o,t){e?r(e):(o&&(0<o.length?o[0].references.forEach(function(e){n.push({displayName:e.displayName.text,nodeId:e.nodeId,reference:e})}):o.references&&o.references.forEach(function(e){n.push({displayName:e.displayName.text,nodeId:e.nodeId,reference:e})})),i(n))})}else r(new Error("Session Is Not Valid To Browse For Event Types"))})},de.biancoroyal.opcua.iiot.core.listener.analyzeEvent=function(a,c,s){var d=de.biancoroyal.opcua.iiot.core.listener.core,l=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(e,i){if(a)if(c&&"function"==typeof c)if(s){var o=0,r={},n=[];s.forEach(function(t){l.eventDebugLog("variant entry: "+t.toString());try{t.dataType&&t.value&&(r=l.collectAlarmFields(s.monitoringParameters.filter.selectClauses[o],t.dataType.key.toString(),t.value),t.dataType===d.nodeOPCUA.DataType.NodeId?c(a,t.value,function(e,o){e?i(e):(r.browseName=o,n.push({eventInformation:r,eventData:t.toJSON()}))}):n.push({eventInformation:r,eventData:t.toJSON()})),o++}catch(e){r={error:e},n.push({eventInformation:r,eventData:t.toJSON()})}}),e(n)}else i(new Error("Event Response Not Valid"));else i(new Error("BrowseForBrowseName Is Not Valid Function"));else i(new Error("Session Is Not Valid To Analyze Event"))})},de.biancoroyal.opcua.iiot.core.listener.checkState=function(e,o,t){return this.internalDebugLog("Check Listener State "+e.stateMachine.getMachineState()+" By "+t),!e.connector||!e.stateMachine||e.stateMachine.getMachineState()===this.RUNNING_STATE||(this.internalDebugLog("Wrong Listener State "+e.stateMachine.getMachineState()+" By "+t),e.showErrors&&e.error(new Error("Listener Not "+this.RUNNING_STATE+" On "+t),o),!1)},module.exports=de.biancoroyal.opcua.iiot.core.listener;
//# sourceMappingURL=../maps/core/opcua-iiot-core-listener.js.map
