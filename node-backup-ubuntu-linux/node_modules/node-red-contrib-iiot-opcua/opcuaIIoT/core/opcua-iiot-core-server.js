"use strict";require("source-map-support").install();var de=de||{biancoroyal:{opcua:{iiot:{core:{server:{}}}}}};de.biancoroyal.opcua.iiot.core.server.core=de.biancoroyal.opcua.iiot.core.server.core||require("./opcua-iiot-core"),de.biancoroyal.opcua.iiot.core.server.internalDebugLog=de.biancoroyal.opcua.iiot.core.server.internalDebugLog||require("debug")("opcuaIIoT:server"),de.biancoroyal.opcua.iiot.core.server.detailDebugLog=de.biancoroyal.opcua.iiot.core.server.detailDebugLog||require("debug")("opcuaIIoT:server:details"),de.biancoroyal.opcua.iiot.core.server.isa95DebugLog=de.biancoroyal.opcua.iiot.core.server.isa95DebugLog||require("debug")("opcuaIIoT:server:ISA95"),de.biancoroyal.opcua.iiot.core.server.isa95DetailDebugLog=de.biancoroyal.opcua.iiot.core.server.isa95DetailDebugLog||require("debug")("opcuaIIoT:server:ISA95:details"),de.biancoroyal.opcua.iiot.core.server.flex=de.biancoroyal.opcua.iiot.core.server.flex||{},de.biancoroyal.opcua.iiot.core.server.flex.internalDebugLog=de.biancoroyal.opcua.iiot.core.server.flex.internalDebugLog||require("debug")("opcuaIIoT:server:flex"),de.biancoroyal.opcua.iiot.core.server.flex.detailDebugLog=de.biancoroyal.opcua.iiot.core.server.flex.detailDebugLog||require("debug")("opcuaIIoT:server:flex:details"),de.biancoroyal.opcua.iiot.core.server.simulatorInterval=de.biancoroyal.opcua.iiot.core.server.simulatorInterval||null,de.biancoroyal.opcua.iiot.core.server.maxTimeInterval=de.biancoroyal.opcua.iiot.core.server.maxTimeInterval||5e5,de.biancoroyal.opcua.iiot.core.server.timeInterval=de.biancoroyal.opcua.iiot.core.server.timeInterval||1,de.biancoroyal.opcua.iiot.core.server.UNLIMITED_LISTENERS=de.biancoroyal.opcua.iiot.core.server.UNLIMITED_LISTENERS||0,de.biancoroyal.opcua.iiot.core.server.intervalList=de.biancoroyal.opcua.iiot.core.server.intervalList||[],de.biancoroyal.opcua.iiot.core.server.path=de.biancoroyal.opcua.iiot.core.server.path||require("path"),de.biancoroyal.opcua.iiot.core.server.simulateVariation=function(e){var r=de.biancoroyal.opcua.iiot.core.server,o=(1+Math.sin(r.timeInterval/360*3))/2;r.timeInterval++,r.timeInterval>r.maxTimeInterval&&(r.timeInterval=1),e.tankLevel&&e.tankLevel.setValueFromSource({dataType:"Double",value:o}),e.tankLevel2&&e.tankLevel2.setValueFromSource({dataType:"Double",value:o})},de.biancoroyal.opcua.iiot.core.server.constructAddressSpaceFromScript=function(o,a,i){return de.biancoroyal.opcua.iiot.core.server.flex.internalDebugLog("Construct Address Space From Script"),new Promise(function(e,r){if(o.engine&&a&&""!==a)try{a(o,o.engine.addressSpace,i,e)}catch(e){r(e)}else r(new Error("Wrong Parameters Construct AddressSpace From Script"))})},de.biancoroyal.opcua.iiot.core.server.constructAddressSpace=function(D,h){var A=this.core.nodeOPCUA.LocalizedText;return new Promise(function(e,r){if(D){var s=de.biancoroyal.opcua.iiot.core.server,o=D.engine.addressSpace,a=o.getOwnNamespace();if(o){var i=a.addView({organizedBy:o.rootFolder.views,browseName:"BiancoRoyalView",displayName:[new A({text:"Bianco Royal View",locale:"en-US"}),new A({text:"Bianco Royal Sicht",locale:"de-DE"})]});if(h){var t=require("../helpers/alarms-and-conditions-demo").constructAlarmAddressSpaceDemo,n={};t(n,o),de.biancoroyal.opcua.iiot.core.server.timeInterval=1,de.biancoroyal.opcua.iiot.core.server.simulatorInterval=setInterval(function(){de.biancoroyal.opcua.iiot.core.server.simulateVariation(n)},500),de.biancoroyal.opcua.iiot.core.server.intervalList.push(de.biancoroyal.opcua.iiot.core.server.simulatorInterval);var d=a.addObject({organizedBy:o.rootFolder.objects,nodeId:"i=1234",browseName:"BiancoRoyal",displayName:[new A({text:"Bianco Royal",locale:"en-US"}),new A({text:"Bianco Royal",locale:"de-DE"})],description:"Bianco Royal - Software InnovationsÂ®"}),l=1;de.biancoroyal.opcua.iiot.core.server.intervalList.push(setInterval(function(){l<1e6?l+=1:l=0},100)),a.addVariable({componentOf:d,nodeId:"i=16479",browseName:"MyVariable1",dataType:"Double",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",value:l})}}});var c=10;a.addVariable({componentOf:d,nodeId:"b=1020FFAA",browseName:"MyVariable2",dataType:"Double",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",value:c})},set:function(e){return c=parseFloat(e.value),s.core.nodeOPCUA.StatusCodes.Good}}});var u=1e3;a.addVariable({componentOf:d,nodeId:"s=TestReadWrite",browseName:"TestReadWrite",displayName:"Test Read and Write",dataType:"Double",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",value:u})},set:function(e){return u=parseFloat(e.value),s.core.nodeOPCUA.StatusCodes.Good}}});var p=a.addVariable({componentOf:d,nodeId:"s=free_memory",browseName:"FreeMemory",displayName:[new A({text:"Free Memory",locale:"en-US"}),new A({text:"ungenutzer RAM",locale:"de-DE"})],dataType:"Double",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",value:s.core.availableMemory()})}}});o.installHistoricalDataNode(p);var v=0;de.biancoroyal.opcua.iiot.core.server.intervalList.push(setInterval(function(){v<65e3?v+=1:v=0},1e3));var y=a.addVariable({componentOf:d,nodeId:"s=Counter",browseName:"Counter",dataType:"UInt16",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"UInt16",value:v})}}});o.installHistoricalDataNode(y);var b=0;de.biancoroyal.opcua.iiot.core.server.intervalList.push(setInterval(function(){b<1e5?b+=1:b=-1e5},500));var g=a.addVariable({componentOf:d,nodeId:"s=FullCounter",browseName:"FullCounter",dataType:"Int32",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Int32",value:b})}}});o.installHistoricalDataNode(g);var m=new s.core.nodeOPCUA.DataValue({value:new s.core.nodeOPCUA.Variant({dataType:"Double",value:10}),sourceTimestamp:null,sourcePicoseconds:0});de.biancoroyal.opcua.iiot.core.server.intervalList.push(setInterval(function(){m.value.value=Math.random(),m.sourceTimestamp=new Date},1e3)),a.addVariable({organizedBy:d,nodeId:"s=Pressure",browseName:"Pressure",dataType:"Double",value:{timestamped_get:function(){return m}}}),a.addVariable({organizedBy:d,nodeId:"s=Matrix",browseName:"Matrix",dataType:"Double",valueRank:2,arrayDimensions:[3,3],value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",arrayType:s.core.nodeOPCUA.VariantArrayType.Matrix,dimensions:[3,3],value:[1,2,3,4,5,6,7,8,9]})}}}),a.addVariable({organizedBy:d,nodeId:"s=Position",browseName:"Position",dataType:"Double",valueRank:1,arrayDimensions:null,value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",arrayType:s.core.nodeOPCUA.VariantArrayType.Array,value:[1,2,3,4]})}}}),a.addVariable({organizedBy:d,nodeId:"s=PumpSpeed",browseName:"PumpSpeed",displayName:[new A({text:"Pump Speed",locale:"en-US"}),new A({text:"Geschwindigkeit Pumpe",locale:"de-DE"})],dataType:"Double",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",value:200+100*Math.sin(Date.now()/1e4)})}}}),a.addVariable({organizedBy:d,nodeId:"s=SomeDate",browseName:"SomeDate",displayName:[new A({text:"Some Date",locale:"en-US"}),new A({text:"Einfaches Datum",locale:"de-DE"})],dataType:"DateTime",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:s.core.nodeOPCUA.DataType.DateTime,value:new Date(Date.UTC(2016,9,13,8,40,0))})}}}),a.addVariable({organizedBy:d,nodeId:"s=MultiLanguageText",browseName:"MultiLanguageText",displayName:[new A({text:"Multi Language Text",locale:"en-US"}),new A({text:"Mehrsprachiger Text",locale:"de-DE"})],dataType:"LocalizedText",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:s.core.nodeOPCUA.DataType.LocalizedText,value:[{text:"multilingual text",locale:"en"},{text:"mehrsprachiger Text",locale:"de"},{text:"texte multilingue",locale:"fr"}]})}}});var S=a.addVariable({organizedBy:d,nodeId:"s=FanSpeed",browseName:"FanSpeed",dataType:"Double",value:new s.core.nodeOPCUA.Variant({dataType:"Double",value:1e3})});de.biancoroyal.opcua.iiot.core.server.intervalList.push(setInterval(function(){S.setValueFromSource(new s.core.nodeOPCUA.Variant({dataType:"Double",value:100*Math.random()-50+1e3}))},10)),a.addMethod(d,{nodeId:"i=12345",browseName:"Bark",inputArguments:[{name:"barks",dataType:"UInt32",arrayType:s.core.nodeOPCUA.VariantArrayType.Scalar,description:{text:"specifies the number of time I should bark"}},{name:"volume",dataType:"UInt32",arrayType:s.core.nodeOPCUA.VariantArrayType.Scalar,description:{text:"specifies the sound volume [0 = quiet ,100 = loud]"}}],outputArguments:[{name:"Barks",dataType:"String",arrayType:s.core.nodeOPCUA.VariantArrayType.Array,description:{text:"the generated barks"},valueRank:1}]}).bindMethod(function(e,r,o){for(var a=e[0].value,i=e[1].value,t=new Array(i).join("!"),n=[],d=0;d<a;d++)n.push("Whaff"+t);o(null,{statusCode:s.core.nodeOPCUA.StatusCodes.Good,outputArguments:[{dataType:s.core.nodeOPCUA.DataType.String,arrayType:s.core.nodeOPCUA.VariantArrayType.Array,value:n}]})});var f=a.addAnalogDataItem({organizedBy:d,nodeId:"s=TemperatureAnalogItem",browseName:"TemperatureAnalogItem",definition:"(tempA -25) + tempB",valuePrecision:.5,engineeringUnitsRange:{low:100,high:200},instrumentRange:{low:-100,high:200},engineeringUnits:s.core.nodeOPCUA.standardUnits.degree_celsius,dataType:"Double",value:{get:function(){return new s.core.nodeOPCUA.Variant({dataType:"Double",value:Math.random()+19})}}});i.addReference({referenceType:"Organizes",nodeId:f.nodeId}),e()}else e()}else r(new Error("No AddressSpace From OPC UA Server Engine"))}else r(new Error("Server Not Valid To Construct Address Space"))})},de.biancoroyal.opcua.iiot.core.server.destructAddressSpace=function(e){de.biancoroyal.opcua.iiot.core.server.intervalList.forEach(function(e,r,o){clearInterval(e),o[r]=null}),de.biancoroyal.opcua.iiot.core.server.intervalList=[],e()},de.biancoroyal.opcua.iiot.core.server.start=function(i,t){var n=this;return new Promise(function(o,a){i?t?i.start(function(e){if(e)a(e);else{if(t.initialized=!0,i.endpoints&&i.endpoints.length){i.endpoints.forEach(function(e){e.endpointDescriptions().forEach(function(e){n.internalDebugLog("Server endpointUrl: "+e.endpointUrl+" securityMode: "+e.securityMode.toString()+" securityPolicyUri: "+e.securityPolicyUri?e.securityPolicyUri.toString():"None Security Policy Uri")})});var r=i.endpoints[0].endpointDescriptions()[0].endpointUrl;n.internalDebugLog("Primary Server Endpoint URL "+r)}i.on("newChannel",function(e){n.internalDebugLog("Client connected with address = "+e.remoteAddress+" port = "+e.remotePort)}),i.on("closeChannel",function(e){n.internalDebugLog("Client disconnected with address = "+e.remoteAddress+" port = "+e.remotePort)}),i.on("create_session",function(e){n.internalDebugLog("############## SESSION CREATED ##############"),e.clientDescription&&(n.detailDebugLog("Client application URI:"+e.clientDescription.applicationUri),n.detailDebugLog("Client product URI:"+e.clientDescription.productUri),n.detailDebugLog((e.clientDescription.applicationName,e.clientDescription.applicationName.toString())),n.detailDebugLog((e.clientDescription.applicationType,e.clientDescription.applicationType.toString()))),n.internalDebugLog((e.sessionName,e.sessionName.toString())),n.internalDebugLog("Session timeout:"+e.sessionTimeout),n.internalDebugLog("Session id:"+e.sessionId)}),i.on("session_closed",function(e,r){n.internalDebugLog("############## SESSION CLOSED ##############"),n.internalDebugLog("reason:"+r),n.internalDebugLog((e.sessionName,e.sessionName.toString()))}),n.internalDebugLog("Server Initialized"),i.serverInfo&&n.detailDebugLog("Server Info:"+JSON.stringify(i.serverInfo)),o()}}):a(new Error("Node Not Valid To Start")):a(new Error("Server Not Valid To Start"))})},de.biancoroyal.opcua.iiot.core.server.readConfigOfServerNode=function(e,r){return e.name=r.name,e.port=r.port,e.endpoint=r.endpoint,e.alternateHostname=r.alternateHostname,e.maxAllowedSessionNumber=parseInt(r.maxAllowedSessionNumber)||10,e.maxConnectionsPerEndpoint=parseInt(r.maxConnectionsPerEndpoint)||10,e.maxAllowedSubscriptionNumber=parseInt(r.maxAllowedSubscriptionNumber)||50,e.maxNodesPerRead=r.maxNodesPerRead||1e3,e.maxNodesPerBrowse=r.maxNodesPerBrowse||2e3,e.delayToClose=r.delayToClose||1e3,e.showStatusActivities=r.showStatusActivities,e.showErrors=r.showErrors,e.publicCertificateFile=r.publicCertificateFile,e.privateCertificateFile=r.privateCertificateFile,e.allowAnonymous=r.allowAnonymous,e.users=r.users,e.xmlsets=r.xmlsets,e.isAuditing=r.isAuditing,e.disableDiscovery=!r.serverDiscovery,e.registerServerMethod=r.registerServerMethod||1,e.discoveryServerEndpointUrl=r.discoveryServerEndpointUrl,e.capabilitiesForMDNS=r.capabilitiesForMDNS?r.capabilitiesForMDNS.split(","):[r.capabilitiesForMDNS],e},de.biancoroyal.opcua.iiot.core.server.initServerNode=function(e){return e.assert=require("better-assert"),e.setMaxListeners(this.UNLIMITED_LISTENERS),e.initialized=!1,e.opcuaServer=null,e},de.biancoroyal.opcua.iiot.core.server.loadNodeSets=function(e,r){var o=this,a=this,i=[this.core.nodeOPCUA.standard_nodeset_file];return e.xmlsets&&(e.xmlsets.forEach(function(e){a.detailDebugLog("Load XML Set for "+e.name),e.path&&(e.path.startsWith("public/vendor/")?i.push(o.path.join(r,e.path)):i.push(e.path),e.path.includes("ISA95")&&a.isa95DebugLog("installing ISA95 extend"))}),this.detailDebugLog("appending xmlFiles: "+i.toString())),this.detailDebugLog("node set:"+i.toString()),e.xmlFiles=i,e},de.biancoroyal.opcua.iiot.core.server.loadCertificates=function(e){var r=this.core.getNodeOPCUAServerPath();return this.detailDebugLog("config: "+e.publicCertificateFile),null!==e.publicCertificateFile&&""!==e.publicCertificateFile||(e.publicCertificateFile=this.path.join(r,"/certificates/server_selfsigned_cert_2048.pem"),this.detailDebugLog("default key: "+e.publicCertificateFile)),this.detailDebugLog("config: "+e.privateCertificateFile),null!==e.privateCertificateFile&&""!==e.privateCertificateFile||(e.privateCertificateFile=this.path.join(r,"/certificates/PKI/own/private/private_key.pem"),this.detailDebugLog("default key: "+e.privateCertificateFile)),e},de.biancoroyal.opcua.iiot.core.server.checkUser=function(e,r,o){var a=!1;return this.detailDebugLog("Server User Request For "+r),e.users.forEach(function(e){r===e.name&&o===e.password&&(a=!0)}),a?this.detailDebugLog("Valid Server User Found"):this.detailDebugLog("Server User "+r+" Not Found"),a},de.biancoroyal.opcua.iiot.core.server.initRegisterServerMethod=function(e){if(e.initialized=!1,e.opcuaServer=null,e.registerServerMethod)switch(parseInt(e.registerServerMethod)){case 2:e.registerServerMethod=this.core.nodeOPCUA.RegisterServerMethod.MDNS;break;case 3:e.registerServerMethod=this.core.nodeOPCUA.RegisterServerMethod.LDS;break;default:e.registerServerMethod=this.core.nodeOPCUA.RegisterServerMethod.HIDDEN}else e.registerServerMethod=this.core.nodeOPCUA.RegisterServerMethod.HIDDEN;return e},de.biancoroyal.opcua.iiot.core.server.setDiscoveryOptions=function(e,r){return e.disableDiscovery||(r.registerServerMethod=e.registerServerMethod,e.discoveryServerEndpointUrl&&""!==e.discoveryServerEndpointUrl&&(r.discoveryServerEndpointUrl=e.discoveryServerEndpointUrl),e.capabilitiesForMDNS&&e.capabilitiesForMDNS.length&&(r.capabilitiesForMDNS=e.capabilitiesForMDNS)),r},de.biancoroyal.opcua.iiot.core.server.getAddressSpace=function(e,r){return e.opcuaServer.engine.addressSpace?e.opcuaServer.engine.addressSpace:(e.error(new Error("Server AddressSpace Not Valid"),r),null)},de.biancoroyal.opcua.iiot.core.server.addVariableToAddressSpace=function(e,r,o){var a=this,i=this.getAddressSpace(e);if(i){var t=i.findNode(r.payload.referenceNodeId),n=this.core.getVariantValue(r.payload.datatype,r.payload.value),d=this.core.nodeOPCUA.LocalizedText;i.getOwnNamespace().addVariable({componentOf:t,nodeId:r.payload.nodeId,browseName:r.payload.browsename,displayName:new d({locale:null,text:r.payload.displayname}),dataType:r.payload.datatype,value:{get:function(){return new a.core.nodeOPCUA.Variant({dataType:a.core.nodeOPCUA.DataType[r.payload.datatype],value:n})},set:function(e){return n=e.value,a.core.nodeOPCUA.StatusCodes.Good}}}),a.internalDebugLog(r.payload.nodeId+" "+o+" Added To Address Space")}},de.biancoroyal.opcua.iiot.core.server.addObjectToAddressSpace=function(e,r,o){var a=this.getAddressSpace(e);if(a){var i=a.findNode(r.payload.referenceNodeId),t=this.core.nodeOPCUA.LocalizedText;i?(a.getOwnNamespace().addObject({organizedBy:i,nodeId:r.payload.nodeId,browseName:r.payload.browsename,displayName:new t({locale:null,text:r.payload.displayname})}),this.internalDebugLog(r.payload.nodeId+" "+o+" Added To Address Space")):e.error(new Error("Root Reference Not Found"),r)}},de.biancoroyal.opcua.iiot.core.server.deleteNOdeFromAddressSpace=function(e,r){var o=this.getAddressSpace(e);if(o)if(r.payload.nodeId){var a=o.findNode(r.payload.nodeId);a?(this.internalDebugLog("Delete NodeId "+r.payload.nodeId),o.deleteNode(a)):this.internalDebugLog("Delete NodeId Not Found "+r.payload.nodeId)}else e.error(new Error("OPC UA Command NodeId Not Valid"),r)},de.biancoroyal.opcua.iiot.core.server.restartServer=function(e){e.opcuaServer?e.opcuaServer.shutdown(function(){e.emit("shutdown"),e.initNewServer()}):(e.opcuaServer=null,e.emit("shutdown"),e.initNewServer()),e.send({payload:"server shutdown"}),this.core.setNodeStatusTo(e,"shutdown")},de.biancoroyal.opcua.iiot.core.server.handleServerError=function(e,r,o){this.internalDebugLog(r),e.showErrors&&e.error(r,o)},de.biancoroyal.opcua.iiot.core.server.createServerNameWithPrefix=function(e){return"NodeRED-IIoT-"+(""!==e?e+"-":e)+"Server"},de.biancoroyal.opcua.iiot.core.server.buildServerOptions=function(e,r){var o=this.core.nodeOPCUA.get_fully_qualified_domain_name,a=this.core.nodeOPCUA.makeApplicationUrn,i=new Date;return{port:e.port,nodeset_filename:e.xmlFiles,resourcePath:e.endpoint||"UA/NodeRED"+r+"IIoTServer",buildInfo:{productName:e.name||"NodeOPCUA IIoT Server",buildNumber:i.timestamp,buildDate:i},serverCapabilities:{operationLimits:{maxNodesPerRead:e.maxNodesPerRead,maxNodesPerBrowse:e.maxNodesPerBrowse}},serverInfo:{applicationUri:a(o(),this.createServerNameWithPrefix(r)),productUri:this.createServerNameWithPrefix(r),applicationName:{text:"Node-RED",locale:"en"},gatewayServerUri:null,discoveryProfileUri:null,discoveryUrls:[]},maxAllowedSessionNumber:e.maxAllowedSessionNumber,maxConnectionsPerEndpoint:e.maxConnectionsPerEndpoint,allowAnonymous:e.allowAnonymous,certificateFile:e.publicCertificateFile,privateKeyFile:e.privateCertificateFile,alternateHostname:e.alternateHostname||"",userManager:null,isAuditing:e.isAuditing,disableDiscovery:e.disableDiscovery}},de.biancoroyal.opcua.iiot.core.server.createServerObject=function(e,r){return this.core.nodeOPCUA.OPCUAServer.MAX_SUBSCRIPTION=e.maxAllowedSubscriptionNumber,new this.core.nodeOPCUA.OPCUAServer(r)},de.biancoroyal.opcua.iiot.core.server.setOPCUAServerListener=function(e){var r=this;e.opcuaServer.on("newChannel",function(e){r.internalDebugLog("Client connected new channel with address = ".bgYellow,e.remoteAddress," port = ",e.remotePort)}),e.opcuaServer.on("closeChannel",function(e){r.internalDebugLog("Client disconnected close channel with address = ".bgCyan,e.remoteAddress," port = ",e.remotePort)}),e.opcuaServer.on("post_initialize",function(){r.internalDebugLog("initialized")})},module.exports=de.biancoroyal.opcua.iiot.core.server;
//# sourceMappingURL=../maps/core/opcua-iiot-core-server.js.map
