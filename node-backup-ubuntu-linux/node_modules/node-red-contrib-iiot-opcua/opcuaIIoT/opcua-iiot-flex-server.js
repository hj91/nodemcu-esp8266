"use strict";module.exports=function(n){require("source-map-support").install();var o=require("./core/opcua-iiot-core-server"),i=require("vm2").VM,a={};n.nodes.registerType("OPCUA-IIoT-Flex-Server",function(e){n.nodes.createNode(this,e),o.flex.internalDebugLog("Open Server Node");var t=o.readConfigOfServerNode(this,e);t=o.initServerNode(this),t=o.loadNodeSets(t,__dirname),t=o.loadCertificates(t);var r=new i({sandbox:{node:t,coreServer:o,scriptObjects:a,RED:n}});t.constructAddressSpaceScript=function(e,r,t){e.internalDebugLog("Init Function Block Flex Server")},r.run("node.constructAddressSpaceScript = "+e.addressSpaceScript),t.buildServerOptions=function(){var e=o.buildServerOptions(t,"Flex");return e.userManager={isValidUser:function(e,r){return o.checkUser(t,e,r)}},o.setDiscoveryOptions(t,e)},t.createServer=function(e){n.settings.verbose&&o.flex.detailDebugLog("serverOptions:"+JSON.stringify(e)),t.opcuaServer=o.createServerObject(t,e),o.core.setNodeStatusTo(t,"waiting"),t.opcuaServer.initialize(t.postInitialize),o.setOPCUAServerListener(t)},t.initNewServer=function(){var e=(t=o.initRegisterServerMethod(t)).buildServerOptions();e=o.setDiscoveryOptions(t,e);try{t.createServer(e)}catch(e){t.emit("server_create_error"),o.flex.internalDebugLog(e.message),o.handleServerError(t,e,{payload:"Flex Server Failure! Please, check the server settings!"})}},t.postInitialize=function(){t.eventObjects={},o.constructAddressSpaceFromScript(t.opcuaServer,t.constructAddressSpaceScript,t.eventObjects).then(function(){o.start(t.opcuaServer,t).then(function(){o.core.setNodeStatusTo(t,"active"),t.emit("server_running")}).catch(function(e){t.emit("server_start_error"),o.core.setNodeStatusTo(t,"errors"),o.handleServerError(t,e,{payload:"Server Start Failure"})})}).catch(function(e){o.handleServerError(t,e,{payload:"Server Address Space Failure"})})},t.initNewServer(),t.on("input",function(e){t.opcuaServer&&t.initialized?"CMD"===e.injectType?t.executeOpcuaCommand(e):o.handleServerError(t,new Error("Unknown Flex Inject Type "+e.injectType),e):o.handleServerError(t,new Error("Server Not Ready For Inputs"),e)}),t.executeOpcuaCommand=function(e){"restart"===e.commandType?(t.restartServer(),t.send(e)):o.handleServerError(t,new Error("Unknown Flex OPC UA Command"),e)},t.restartServer=function(){o.flex.internalDebugLog("Restart OPC UA Server"),o.restartServer(t),t.opcuaServer?o.flex.internalDebugLog("OPC UA Server restarted"):o.flex.internalDebugLog("Can not restart OPC UA Server")},t.on("close",function(e){t.closeServer(function(){o.flex.internalDebugLog("Close Server Node"),e()})}),t.closeServer=function(e){o.simulatorInterval&&(clearInterval(o.simulatorInterval),o.simulatorInterval=null),t.opcuaServer?t.opcuaServer.shutdown(t.delayToClose,e):e()}})};
//# sourceMappingURL=maps/opcua-iiot-flex-server.js.map
