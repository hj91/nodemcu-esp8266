"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}module.exports=function(s){require("source-map-support").install();var c=require("./core/opcua-iiot-core-listener"),t=require("collections/map"),n=require("underscore");s.nodes.registerType("OPCUA-IIoT-Listener",function(e){s.nodes.createNode(this,e),this.action=e.action,this.queueSize=e.queueSize||1,this.name=e.name,this.topic=e.topic,this.justValue=e.justValue,this.useGroupItems=e.useGroupItems,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.connector=s.nodes.getNode(e.connector);var d=this;d.opcuaClient=null;var u=d.opcuaSession=null,r=c.core.nodeOPCUA.StatusCodes,o=c.core.nodeOPCUA.AttributeIds;d.monitoredItems=new t,d.monitoredASO=new t,d.messageQueue=[],d.stateMachine=c.createStatelyMachine(),c.internalDebugLog("Start FSM: "+d.stateMachine.getMachineState()),c.detailDebugLog("FSM events:"+d.stateMachine.getMachineEvents()),d.createSubscription=function(e){if("IDLE"===d.stateMachine.getMachineState()){c.internalDebugLog("Create Subscription On State "+d.stateMachine.getMachineState()),u=null,d.stateMachine.requestinitsub();var t="number"==typeof e.payload?e.payload:null,o=e.payload.listenerParameters?e.payload.listenerParameters.options:e.payload.options;if("events"!==d.action){c.internalDebugLog("create monitoring subscription");var n=o||c.getSubscriptionParameters(t);d.makeSubscription(n)}else{c.internalDebugLog("create event subscription");var i=o||c.getEventSubscribtionParameters(t);d.makeSubscription(i)}}else c.internalDebugLog("New Subscription Request On State "+d.stateMachine.getMachineState())},d.setSubscriptionEvents=function(e){e.on("started",function(){c.internalDebugLog("Subscription started"),c.core.setNodeStatusTo(d,"started"),d.monitoredItems.clear(),d.stateMachine.startsub()}),e.on("terminated",function(){c.internalDebugLog("Subscription terminated"),c.core.setNodeStatusTo(d,"terminated"),d.stateMachine.terminatesub().idlesub(),d.resetSubscription()}),e.on("internal_error",function(e){c.internalDebugLog("internal_error: "+e.message),d.showErrors&&d.error(e,{payload:"Internal Error"}),c.core.setNodeStatusTo(d,"error"),d.stateMachine.errorsub(),d.resetSubscription()}),e.on("item_added",function(e){d.setMonitoring(e),d.updateSubscriptionStatus()})},d.makeSubscription=function(e){c.core.checkSessionNotValid(d.opcuaSession,"ListenerSubscription")||(e?(c.internalDebugLog("Subscription Parameters: "+JSON.stringify(e)),u=new c.core.nodeOPCUA.ClientSubscription(d.opcuaSession,e),c.internalDebugLog("New Subscription Created"),d.connector&&(d.connector.hasOpcUaSubscriptions=!0),d.setSubscriptionEvents(u),d.stateMachine.initsub()):c.internalDebugLog("Subscription Parameters Not Valid"))},d.resetSubscription=function(){d.sendAllMonitoredItems("SUBSCRIPTION TERMINATED")},d.sendAllMonitoredItems=function(e){var o=[];d.monitoredASO.forEach(function(e,t){o.push({name:"",nodeId:t,datatypeName:""})}),d.send({payload:e,addressSpaceItems:o}),d.monitoredItems.clear(),d.monitoredASO.clear()},d.subscribeActionInput=function(e){d.stateMachine.getMachineState()!==c.RUNNING_STATE?d.messageQueue.push(e):d.subscribeMonitoredItem(e)},d.subscribeEventsInput=function(e){d.stateMachine.getMachineState()!==c.RUNNING_STATE?d.messageQueue.push(e):d.subscribeMonitoredEvent(e)},d.updateSubscriptionStatus=function(){c.internalDebugLog("listening ("+d.monitoredItems.size+")"),c.core.setNodeStatusTo(d,"listening ("+d.monitoredItems.size+")")},d.handleMonitoringOfGroupedItems=function(t){d.monitoredItemGroup&&null!==d.monitoredItemGroup.groupId?d.monitoredItemGroup.terminate(function(e){e&&(c.internalDebugLog("Monitoring Terminate Error"),c.internalDebugLog(e)),d.monitoredItems.clear(),d.monitoredASO.clear(),d.monitoredItemGroup.groupId=null,d.updateSubscriptionStatus()}):c.buildNewMonitoredItemGroup(d,t,t.addressSpaceItems,u).then(function(e){e.monitoredItemGroup?(e.monitoredItemGroup.groupId=n.uniqueId("group_"),d.monitoredItemGroup=e.monitoredItemGroup):d.error(new Error("No Monitored Item Group In Result Of NodeOPCUA"))}).catch(function(e){c.subscribeDebugLog("Monitoring Build Item Group Error"),c.subscribeDebugLog(e),d.showErrors&&d.error(e,t)})},d.handleMonitoringOfItems=function(n){var e=n.addressSpaceItems.filter(function(e){var t="string"==typeof e.nodeId?e.nodeId:e.nodeId.toString();return void 0===d.monitoredASO.get(t)}),t=n.addressSpaceItems.filter(function(e){var t="string"==typeof e.nodeId?e.nodeId:e.nodeId.toString();return void 0!==d.monitoredASO.get(t)});if(0<e.length){var o=Object.assign({},n);o.addressSpaceItems=e,c.subscribeDebugLog("itemsToMonitor "+e.length),c.monitorItems(d,o,u)}0<t.length&&(c.subscribeDebugLog("itemsToTerminate "+t.length),t.forEach(function(e){var t="string"==typeof e.nodeId?e.nodeId:e.nodeId.toString(),o=d.monitoredASO.get(t);o&&o.monitoredItem?(c.subscribeDebugLog("Monitored Item Unsubscribe "+t),o.monitoredItem.terminate(function(e){c.subscribeDebugLog("Terminated Monitored Item "+o.monitoredItem.itemToMonitor.nodeId),d.monitoredItemTerminated(n,o.monitoredItem,t,e)})):c.subscribeDebugLog("Monitored Item Was Not Monitoring "+t)}))},d.subscribeMonitoredItem=function(e){c.core.checkSessionNotValid(d.opcuaSession,"MonitorListener")||c.checkState(d,e,"Monitoring")&&e.addressSpaceItems.length&&(d.useGroupItems?d.handleMonitoringOfGroupedItems(e):d.handleMonitoringOfItems(e))},d.handleEventSubscriptions=function(i){var e=!0,t=!1,o=void 0;try{for(var r,n=function(){var e=r.value;if(!e.nodeId)return c.eventDebugLog("Address Space Item Not Valid to Monitor Event Of "+e),{v:void 0};if("ns=0;i=0"===e.datatypeName)return c.subscribeDebugLog("Address Space Item Not Allowed to Monitor "+e),{v:void 0};var t=void 0;t="string"==typeof e.nodeId?e.nodeId:e.nodeId.toString();var o=d.monitoredASO.get(t);if(o){c.eventDebugLog("Terminate Event Item"+t);var n=Object.assign({},i);o.monitoredItem.terminate(function(e){c.eventDebugLog("Terminated Monitored Item "+o.monitoredItem.itemToMonitor.nodeId),d.monitoredItemTerminated(n,o.monitoredItem,t,e)})}else c.eventDebugLog("Regsiter Event Item "+t),c.buildNewEventItem(t,i,u).then(function(e){e.monitoredItem.monitoredItemId&&(c.eventDebugLog("Event Item Regsitered "+e.monitoredItem.monitoredItemId+" to "+e.nodeId),d.monitoredASO.set(e.nodeId.toString(),{monitoredItem:e.monitoredItem,topic:i.topic||d.topic}))}).catch(function(e){c.eventDebugLog("Build Event Error"),c.eventDebugLog(e),d.showErrors&&d.error(e,i)})},s=i.addressSpaceItems[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){var a=n();if("object"===_typeof(a))return a.v}}catch(e){t=!0,o=e}finally{try{e||null==s.return||s.return()}finally{if(t)throw o}}},d.subscribeMonitoredEvent=function(e){c.core.checkSessionNotValid(d.opcuaSession,"EventListener")||c.checkState(d,e,"Event")&&d.handleEventSubscriptions(e)},d.monitoredItemTerminated=function(e,t,o,n){n&&(t&&t.monitoredItemId?c.internalDebugLog(n.message+" on "+t.monitoredItemId):c.internalDebugLog(n.message+" on monitoredItem"),d.showErrors&&d.error(n,e)),d.updateMonitoredItemLists(t,o)},d.updateMonitoredItemLists=function(n,e){c.internalDebugLog("updateMonitoredItemLists = UMIL"),n&&n.itemToMonitor&&(d.monitoredItems.has(n.monitoredItemId)&&d.monitoredItems.delete(n.monitoredItemId),c.core.isNodeId(n.itemToMonitor.nodeId)?(c.internalDebugLog("UMIL Terminate Monitored Item "+n.itemToMonitor.nodeId),d.monitoredASO.has(e)&&d.monitoredASO.delete(e)):(c.internalDebugLog("UMIL monitoredItem NodeId is not valid Id:"+n.monitoredItemId),d.monitoredASO.forEach(function(e,t,o){c.internalDebugLog("UMIL monitoredItem removing from ASO list key:"+t+" value "+e.monitoredItem.monitoredItemId),e.monitoredItem.monitoredItemId&&e.monitoredItem.monitoredItemId===n.monitoredItemId&&(c.internalDebugLog("UMIL monitoredItem removed from ASO list"+t),o.delete(t))})),d.updateSubscriptionStatus())},d.setMonitoring=function(e){var t=e;t&&void 0!==t.monitoredItemId?(c.core.isNodeId(t.itemToMonitor.nodeId)||c.internalDebugLog("monitoredItem NodeId is not valid Id:"+t.monitoredItemId),c.internalDebugLog("add monitoredItem to list Id:"+t.monitoredItemId+" nodeId: "+t.itemToMonitor.nodeId),d.monitoredItems.set(t.monitoredItemId,t),t.on("initialized",function(){c.internalDebugLog("monitoredItem "+t.itemToMonitor.nodeId+" initialized on "+t.monitoredItemId)}),t.on("changed",function(e){c.detailDebugLog("data changed for item: "+t.itemToMonitor.nodeId+" with Id "+t.monitoredItemId),t.monitoringParameters.filter?d.sendDataFromEvent(t,e):d.sendDataFromMonitoredItem(t,e)}),t.on("error",function(e){c.internalDebugLog("monitoredItem Error: "+e.message+" on "+t.monitoredItemId),d.showErrors&&d.error(e,{payload:"Monitored Item Error",monitoredItem:t}),d.updateMonitoredItemLists(t,t.itemToMonitor.nodeId),d.connector&&c.core.isSessionBad(e)&&(d.sendAllMonitoredItems("BAD SESSION"),d.terminateSubscription(function(){d.connector.resetBadSession()}))}),t.on("terminated",function(){c.internalDebugLog("Terminated For "+t.monitoredItemId),d.updateMonitoredItemLists(t,t.itemToMonitor.nodeId)})):c.internalDebugLog("monitoredItem Id from server is not valid Id: "+t.monitoredItemId)},d.sendDataFromMonitoredItem=function(e,t){if(e){var o=c.core.isNodeId(e.itemToMonitor.nodeId)?e.itemToMonitor.nodeId.toString():"invalid",n=d.monitoredASO.get(o),i={payload:{},topic:n?n.topic:d.topic,addressSpaceItems:[{name:"",nodeId:o,datatypeName:""}],nodetype:"listen",injectType:"subscribe"};c.internalDebugLog("sendDataFromMonitoredItem: "+i.addressSpaceItems[0].nodeId);var r={};if(i.justValue=d.justValue,d.justValue){r=JSON.stringify(t,null,2);try{s.util.setMessageProperty(i,"payload",JSON.parse(r))}catch(e){d.showErrors&&(d.warn("JSON not to parse from string for monitored item"),d.error(e,i)),i.payload=r,i.error=e.message}}else i.payload={dataValue:t,monitoredItem:e};d.send(i)}else c.internalDebugLog("Monitored Item Is Not Valid On Change Event While Monitoring")},d.handleEventResults=function(t,e,o,n){c.eventDetailDebugLog("Monitored Event Results "+o);var i={};if(d.justValue){i=JSON.stringify({dataValue:e},null,2);try{s.util.setMessageProperty(t,"payload",JSON.parse(i))}catch(e){d.showErrors&&(d.warn("JSON not to parse from string for monitored item"),d.error(e,t)),t.payload=i,t.error=e.message}}else t.payload={dataValue:e,eventResults:o,monitoredItem:n};d.send(t)},d.sendDataFromEvent=function(t,o){if(t){var e=c.core.isNodeId(t.itemToMonitor.nodeId)?t.itemToMonitor.nodeId.toString():"invalid",n=d.monitoredASO.get(e),i={payload:{},topic:(n?n.topic:d.topic)||d.topic,addressSpaceItems:[{name:"",nodeId:e,datatypeName:""}],nodetype:"listen",injectType:"event"};c.analyzeEvent(d.opcuaSession,d.getBrowseName,o).then(function(e){d.handleEventResults(i,o,e,t)}).catch(function(e){d.errorHandling(e)})}else c.internalDebugLog("Monitored Item Is Not Valid On Change Event While Monitoring")},d.errorHandling=function(e){c.internalDebugLog("Basic Error Handling"),c.internalDebugLog(e),d.showErrors&&d.error(e,{payload:"Error Handling"}),e&&c.core.isSessionBad(e)&&(d.sendAllMonitoredItems("BAD SESSION"),d.connector&&d.terminateSubscription(function(){d.connector.resetBadSession()}))},d.getBrowseName=function(e,t,i){c.client.read(e,[{nodeId:t,attributeId:o.BrowseName}],function(e,t,o){if(!e&&o[0].statusCode===r.Good){var n=o[0].value.value.name;return i(null,n)}i(e,"Unknown")})},d.handleListenerInput=function(e){switch(d.action){case"subscribe":d.subscribeMonitoredItem(e);break;case"events":d.subscribeMonitoredEvent(e);break;default:d.error(new Error("Type Of Action To Listener Is Not Valid"),e)}},d.on("input",function(e){if(c.core.checkConnectorState(d,e,"Listener")){if("browse"===e.nodetype&&(e.nodetype="inject",e.injectType="listen",e.addressSpaceItems=c.core.buildNodesToListen(e)),!e.addressSpaceItems||!e.addressSpaceItems.length)return c.subscribeDebugLog("Address-Space-Item Set Not Valid"),void(d.showErrors&&d.error(new Error("Address-Space-Item Set Not Valid"),e));if("IDLE"===d.stateMachine.getMachineState())d.messageQueue.push(e),d.createSubscription(e);else{if(!c.checkState(d,e,"Input"))return void d.messageQueue.push(e);d.handleListenerInput(e)}}}),c.core.registerToConnector(d),d.connector&&(d.connector.on("connector_init",function(){c.internalDebugLog("Reset Subscription On Connector Init"),u=null,d.monitoredItems=new t,d.monitoredASO=new t,d.stateMachine=c.createStatelyMachine(),d.monitoredItemGroup=null}),d.connector.on("connection_stopped",function(){d.terminateSubscription(function(){u=null,c.internalDebugLog("Subscription Was Terminated On Connector Event -> connection stopped")})}),d.connector.on("connection_end",function(){d.terminateSubscription(function(){u=null,c.internalDebugLog("Subscription Was Terminated On Connector Event -> connection ends")})}),d.connector.on("connection_reconfigure",function(){d.terminateSubscription(function(){u=null,c.internalDebugLog("Subscription Was Terminated On Connector Event -> connection reconfigure")})}),d.connector.on("connection_renew",function(){d.terminateSubscription(function(){u=null,c.internalDebugLog("Subscription Was Terminated On Connector Event -> connection renew")})})),d.terminateSubscription=function(e){u&&d.stateMachine.getMachineState()===c.RUNNING_STATE?(d.stateMachine.terminatesub(),u.terminate(function(){d.stateMachine.idlesub(),e()})):(d.stateMachine.idlesub(),e())},d.on("close",function(e){d.terminateSubscription(function(){u=null,c.core.deregisterToConnector(d,e),c.internalDebugLog("Close Listener Node")})}),d.stateMachine.onIDLE=function(e,t,o){c.detailDebugLog("Listener IDLE Event FSM")},d.stateMachine.onREQUESTED=function(e,t,o){c.detailDebugLog("Listener REQUESTED Event FSM")},d.stateMachine.onINIT=function(e,t,o){c.detailDebugLog("Listener INIT Event FSM")},d.stateMachine.onSTARTED=function(e,t,o){switch(c.detailDebugLog("Listener STARTED Event FSM"),d.action){case"subscribe":for(;0<d.messageQueue.length;)d.subscribeMonitoredItem(d.messageQueue.shift());break;case"events":for(;0<d.messageQueue.length;)d.subscribeMonitoredEvent(d.messageQueue.shift());break;default:c.internalDebugLog("Unknown Action Type "+d.action)}},d.stateMachine.onTERMINATED=function(e,t,o){c.detailDebugLog("Listener TERMINATED Event FSM")},d.stateMachine.onERROR=function(e,t,o){c.detailDebugLog("Listener ERROR Event FSM")},d.stateMachine.onEND=function(e,t,o){c.detailDebugLog("Listener END Event FSM")}})};
//# sourceMappingURL=maps/opcua-iiot-listener.js.map
