"use strict";module.exports=function(s){require("source-map-support").install();var c=require("./core/opcua-iiot-core-client");s.nodes.registerType("OPCUA-IIoT-Read",function(e){s.nodes.createNode(this,e),this.attributeId=parseInt(e.attributeId)||0,this.maxAge=parseInt(e.maxAge)||1,this.depth=parseInt(e.depth)||1,this.name=e.name,this.justValue=e.justValue,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.parseStrings=e.parseStrings,this.historyDays=parseInt(e.historyDays)||1,this.connector=s.nodes.getNode(e.connector);var l=c.core.initClientNode(this);l.handleReadError=function(e,t){c.readDebugLog(e),l.showErrors&&l.error(e,t),l.connector&&c.core.isSessionBad(e)&&l.connector.resetBadSession()},l.readAllFromNodeId=function(e,t,r){c.readAllAttributes(e,t,r).then(function(t){try{l.send(l.buildResultMessage("AllAttributes",t))}catch(e){l.handleReadError(e,t.msg)}}).catch(function(e){l.handleReadError(e,r)})},l.readValueFromNodeId=function(e,t,r){c.readVariableValue(e,t,r).then(function(e){var t=l.buildResultMessage("VariableValue",e);l.send(t)}).catch(function(e){l.handleReadError(e,r)})},l.readHistoryDataFromNodeId=function(e,t,r){var a=new Date;l.historyStart=new Date,l.historyStart.setDate(a.getDate()-l.historyDays),l.historyEnd=new Date,c.readHistoryValue(e,t,r.payload.historyStart||l.historyStart,r.payload.historyEnd||l.historyEnd,r).then(function(e){var t=l.buildResultMessage("HistoryValue",e);t.historyStart=e.startDate||l.historyStart,t.historyEnd=e.endDate||l.historyEnd,l.send(t)}).catch(function(e){l.handleReadError(e,r)})},l.readFromNodeId=function(e,t,r){var a=null,s=[],o=!0,n=!1,i=void 0;try{for(var d,u=t[Symbol.iterator]();!(o=(d=u.next()).done);o=!0)a={nodeId:d.value,attributeId:Number(l.attributeId)||null},s.push(a)}catch(e){n=!0,i=e}finally{try{o||null==u.return||u.return()}finally{if(n)throw i}}c.read(e,s,r.payload.maxAge||l.maxAge,r).then(function(e){var t=l.buildResultMessage("Default",e);t.maxAge=l.maxAge,l.send(t)}).catch(function(e){l.handleReadError(e,r)})},l.readFromSession=function(e,t,r){var a=Object.assign({},r);if(!c.core.checkSessionNotValid(e,"Reader"))switch(c.readDebugLog("Read With AttributeId "+l.attributeId),parseInt(l.attributeId)){case c.READ_TYPE.ALL:l.readAllFromNodeId(e,t,a);break;case c.READ_TYPE.VALUE:l.readValueFromNodeId(e,t,a);break;case c.READ_TYPE.HISTORY:l.readHistoryDataFromNodeId(e,t,a);break;default:l.readFromNodeId(e,t,a)}},l.buildResultMessage=function(e,t){var r=Object.assign({},t.msg);r.payload={},r.nodetype="read",r.readtype=e,r.attributeId=l.attributeId,r.justValue=l.justValue;var a=l.extractDataValueString(t);return r=l.setMessageProperties(r,t,a),l.justValue||(r=l.enhanceMessage(r,t)),r},l.extractDataValueString=function(e){return l.justValue?JSON.stringify(e.results,null,2):JSON.stringify(e,null,2)},l.setMessageProperties=function(t,r,a){try{s.util.setMessageProperty(t,"payload",JSON.parse(a))}catch(e){l.showErrors&&(l.warn("JSON not to parse from string for dataValues type "+JSON.stringify(r,null,2)),l.error(e,r.msg)),t.payload=a,t.error=e.message}return t},l.enhanceMessage=function(t,r){try{t.resultsConverted={};var e=JSON.stringify(r.results,null,2);s.util.setMessageProperty(t,"resultsConverted",JSON.parse(e))}catch(e){l.showErrors&&(l.warn("JSON not to parse from string for dataValues type "+r.results),l.error(e,r.msg)),t.resultsConverted=null,t.error=e.message}return t},l.on("input",function(t){if(c.core.checkConnectorState(l,t,"Read"))try{l.readFromSession(l.opcuaSession,c.core.buildNodesToRead(t),t)}catch(e){l.handleReadError(e,t)}}),c.core.registerToConnector(l),l.on("close",function(e){c.core.deregisterToConnector(l,e)})})};
//# sourceMappingURL=maps/opcua-iiot-read.js.map
